<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>启航的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="启航的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="启航的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="启航的博客">
<meta name="twitter:description" content="hello world">
  
    <link rel="alternate" href="/atom.xml" title="启航的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">启航的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">很高兴遇见你</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-使用WebSocket和STMOP实现消息功能" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/07/使用WebSocket和STMOP实现消息功能/" class="article-date">
  <time datetime="2019-08-07T11:05:39.000Z" itemprop="datePublished">2019-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/07/使用WebSocket和STMOP实现消息功能/">使用WebSocket和STMOP实现消息功能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>在浏览器和服务器之间发送消息</li>
<li>在SpringMVC控制器中处理消息</li>
<li>为目标用户发送消息</li>
</ul>
<p>Spring4.0为WebSocket通信提供了支持（包括发送和接收消息的低层级API ，高级API，发消息的模板，支持SockJS，用来解决浏览器端度无端以及代理不支持WebSocket的问题</p>
<p>使用低层级API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MacroHandler</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MacroHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">( WebSocketSession session , //处理文本消息</span></span></span><br><span class="line"><span class="function"><span class="params">         TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       logger.info(<span class="string">"Received message:"</span> + message.getPayload());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);<span class="comment">//模拟消息延时</span></span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> TextMessage(<span class="string">"Sail"</span>)); <span class="comment">//发送文本信息</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了处理文本等信息，还有链接的建立和关闭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span></span></span><br><span class="line"><span class="function">    throw Exception</span>&#123;</span><br><span class="line">    logger.info(<span class="string">"connection established"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span></span></span><br><span class="line"><span class="function">	theow Exception</span>&#123;</span><br><span class="line">    logger.info(<span class="string">"Connection closed . status: "</span> + status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已经有了消息处理器类，在配置类上使用@EnableWebSocket，并实现WebSocketConfigurer<br>接口 ， java方式配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandler</span><span class="params">(WebSocketHandlerRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.addHandler(macroHandler(), <span class="string">"//marco"</span>);<span class="comment">//将MacroHandr映射到“/macro"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">   	<span class="function"><span class="keyword">public</span> MarcoHandler <span class="title">marcoHandler</span><span class="params">()</span></span>&#123;<span class="comment">//声明MarcoHandler bean</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarcoHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>借助webSocket命名空间以XML方式配置WebSocket</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">websocket:handlers</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">websocket:mapping</span> <span class="attr">handler</span> =<span class="string">"marcoHandler"</span> <span class="attr">path</span>=<span class="string">"/marco"</span> /&gt;</span><span class="comment">&lt;!--将MarcoHandle 映射到/marco --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">websocket:handlers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"marcoHandler"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"marcopolo.MarcoHandler"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>应对不支持WebSocket的场景</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandler</span><span class="params">(WebSocketHandlerRegistry registry)</span></span>&#123;</span><br><span class="line">      registry.addHandler(macroHandler(), <span class="string">"//marco"</span>).withSockJS();<span class="comment">//将MacroHandr映射到“/macro" ,并启用SockJS</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>使用STOMP消息</p>
<p>Java配置启用基于代理的Web消息功能(@EnableWebSocketMessageBroker注解能够在<br>WebSocket之上启用STOMP )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketStompConfig</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketMessageBrokerConfigurer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndPointRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.addEndPoint(<span class="string">"/marcopolo"</span>).withSocketJS();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.enableSimpleBroker(<span class="string">"/queue"</span>,<span class="string">"/topic"</span>);</span><br><span class="line">        registry.setApplicationDestinationPrefixes(<span class="string">"/app"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理客户端的STOMP消息  <strong>@MessageMapping</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarcoController</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MarcoController.class);</span><br><span class="line">    <span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)  <span class="comment">//关键注解 </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;   <span class="comment">// 处理发往/app/marco目的地的消息</span></span><br><span class="line">        logger.info(<span class="string">"Received message: "</span> + incoming.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为不是HTTP，所以无法使用HttpMessageConverter实现将负载转为Shout对象</p>
<p>有如下几个消息转换器可以处理Message</p>
<table>
<thead>
<tr>
<th>消息转换器</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ByteArrayMessageConverter</td>
<td>实现MIME类型为“application/octetstream”的消息与byte[]之间的相互转换</td>
</tr>
<tr>
<td>MappingJackson2MessageConverter</td>
<td>实现MIME类型为“application/json”的消息与Java对象之间的相互转换</td>
</tr>
<tr>
<td>StringMessageConverter</td>
<td>实现MIME类型为“text/plain”的消息与String之间的相互转换</td>
</tr>
</tbody>
</table>
<p>处理订阅<strong>@SubscribeMapping</strong> </p>
<p>发送消息到客户端</p>
<ol>
<li>作为处理消息或定于的附带结果</li>
<li>使用消息模板</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Shout <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;</span><br><span class="line">    Shout outgoing = <span class="keyword">new</span> Shout();</span><br><span class="line">    outgoing.setMessage(<span class="string">"Polo"</span>);</span><br><span class="line">    <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认帧所发往的目的地会与触发处理器方法的目的地相同 ，可以添加<strong>@SendTo</strong>注解重载目的地</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)</span><br><span class="line"><span class="meta">@SendTo</span>(<span class="string">"/topic/shout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Shout <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;</span><br><span class="line">    Shout outgoing = <span class="keyword">new</span> Shout();</span><br><span class="line">    outgoing.setMessage(<span class="string">"polo"</span>);</span><br><span class="line">    <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@SendToUser</strong> 发送给订阅客户</p>
<p><strong>@MessageExceptionHandler</strong>能处理消息方法中的异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageExceptionHandler</span>(SpittleException,<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span>  <span class="title">SpittleException</span> <span class="title">handleException</span>(<span class="title">SpittleException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">    logger.error(<span class="string">"Error handling message: "</span> + e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/07/使用WebSocket和STMOP实现消息功能/" data-id="cjz15dss600097opuua0j2m64" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring消息" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/Spring消息/" class="article-date">
  <time datetime="2019-08-06T11:58:54.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/Spring消息/">Spring消息</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>异步消息简介</li>
<li>基于JMS的消息功能</li>
<li>使用Spring和AMQP发送消息</li>
<li>消息驱动的POJO</li>
</ul>
<p>1.发送消息</p>
<p>​    有两种通用的目的地：队列和主题，分别是点对点模型和发布/订阅模型</p>
<p>异步消息的优点</p>
<p>​    1.无需等待</p>
<p>​    2.面向消息和解耦</p>
<p>​    3.位置独立</p>
<p>​    4.确保投递</p>
<p>2.使用JMS发送消息</p>
<p>​    使用ActiveMQ</p>
<p>​    1.创建连接工厂</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.spring.ActiveMqConnectionFactory"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>ActiveMQConnectionFactory 会假设ActiveMQ代理监听localhost的61616端口，这样我们可以如下设置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.spring.ActiveMqConnectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:brokeURL</span>=<span class="string">"tcp://localhost:61616"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以通过如下方式声明</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:connectionFactory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">brokerURL</span>=<span class="string">"tcp：//localhost:61616"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>​        2.声明ActiveMQ消息目的地</p>
<p>​        如下定义了一个队列</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"queue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_</span>=<span class="string">"spitter.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>​        如下定义了一个ActiveMQ主题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"topic"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_</span>=<span class="string">"spitter.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>用amq方式声明
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:</span> <span class="attr">queue</span> <span class="attr">id</span>=<span class="string">"spittleQueue"</span> <span class="attr">physicalName</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:</span> <span class="attr">topic</span> <span class="attr">id</span>=<span class="string">"spottleTpoic"</span> <span class="attr">phtsicalName</span>=<span class="string">"spittle.alert.topic"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>不管是哪种类型，都是通过physicalName属性指定消息通道的名称</p>
<p>使用JMS模板</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlertServiceImpl</span> <span class="keyword">implements</span> <span class="title">AlertService</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> JmsOperations jmsIperations;</span><br><span class="line">    <span class="comment">//注入jms模板</span></span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlertServiceImpl</span><span class="params">(JmsOperations jmsOperations)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jmsOperations = jmsOperations;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSpittleAlert</span><span class="params">(<span class="keyword">final</span> Spittle spittle)</span></span>&#123;</span><br><span class="line">        jmsOperations.send(<span class="comment">//发送消息</span></span><br><span class="line">            <span class="string">"spittle.slert.queue"</span>,<span class="comment">//指定目的地</span></span><br><span class="line">            <span class="keyword">new</span> MessageCreator()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Meaasge <span class="title">createMessage</span><span class="params">(Session session)</span></span></span><br><span class="line"><span class="function">               	 throw JMSException</span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> session.createObjectMessage(spittle);<span class="comment">//创建消息</span></span><br><span class="line">            &#125;</span><br><span class="line">        	&#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置默认的目的地</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframeword.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestinationName</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面只是配了一个目的地名称，并没有说明你处理的目的地是什么类型，那么可以将之前的创建的队列或主题的目的地bean装配进来</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframeword.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestination-ref</span>=<span class="string">"spittleTopic"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认JMSTemplate在convertAndSend()方法中会使用 SImpleMessage  Converter。通过将消息转换器声明为bean，并注入到JMStemplate的messageConverter属性，可以重写，如果想用json，可以声名一个MappingJacksonMessageConverter bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageConverter"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframeword.jms.support.converter</span></span></span><br><span class="line"><span class="tag"><span class="string">             --&gt; MappingJacsonMessageConverter"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>注入到JmsTemplate中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestinationName</span>=<span class="string">"spittle.alert.queue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:messageConverter-ref</span>=<span class="string">"messageConverter"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">receiveSpittleAlert</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//接收消息</span></span><br><span class="line">        ObjectMessage receivedMessage = (ObjectMessage) jmsOperations.receive();</span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="keyword">return</span> (Spittle) receivedMessage.getObject();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(JMSException jmsException)&#123;</span><br><span class="line">        <span class="keyword">throw</span> JmsUtils.convertJmsAccessExceptiom(jmsException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MDP异步接收和处理消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleAlertHandler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleSpittleAlert</span><span class="params">(Spittle spittle)</span></span>&#123;<span class="comment">//处理方法</span></span><br><span class="line">        <span class="comment">//...implementation goes here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleSpittleAlert是个纯粹的POJO，可以在Spring中配置消息监听器使他获取消息接收能力，配置如下</p>
<p>1.将处理器声明为bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"spittleHandler"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.habuma.spittr.alerts.SpittleAlertHandler"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.把SpittleAlertHandler 声明为消息监听器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jms:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">jms:listener</span> <span class="attr">destination</span>=<span class="string">"spitter.alert.queue"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">ref</span>=<span class="string">"spittleHandler"</span> <span class="attr">method</span>=<span class="string">"handleSpittleAlert"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jms:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用基于消息的RPC 17.2</p>
<p>使用AMQP实现消息功能</p>
<p>AMQP在消息生产者和传递信息的队列之间引入了一种简介的机制Exchange。生产者和消息队列之间实现了解耦，Exchange这不仅仅是穿透，根据算法的不同，可能会使用消息的routing key 和/ 或者参数， 将Exchange 和队列的binding的routing key和参数进行对比</p>
<table>
<thead>
<tr>
<th>Exchange类型</th>
<th>条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Direct</td>
<td>消息的routing key与binding的routing key直接匹配的话，消息会路由到该队列上</td>
</tr>
<tr>
<td>Topic</td>
<td>消息的routing key与binding的routing key符合通配符匹配，消息会路由到该队列上</td>
</tr>
<tr>
<td>Headers</td>
<td>消息参数表中的头信息和值都与binding参数表中匹配，消息会路由到该队列上</td>
</tr>
<tr>
<td>Fanout</td>
<td>不管消息的routing key和参数表的头信息/值是什么， 消息将会路由到所有队列上</td>
</tr>
</tbody>
</table>
<p>配置RabbitMq</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改连接信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionfactory"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置RabbitTemplate </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"rabbitTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">connection-factory</span>=<span class="string">"connectinFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用RabbitTemplate来发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlertServiceImpl</span> <span class="keyword">implements</span> <span class="title">AlertService</span></span>&#123;</span><br><span class="line">    priivate RabbitTemplate rabbit;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlertServiceImpl</span> <span class="params">(RabbitTemplate rabbit)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbit = rabbit;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSpittleAlert</span><span class="params">(Spittle spittle)</span></span>&#123;</span><br><span class="line">        rabbit.convertAndSend(<span class="string">"spittle.alert.exchange"</span>,</span><br><span class="line">                             <span class="string">"spittle.alerts"</span>,</span><br><span class="line">                             spittle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RabbitTemplate接收消息</p>
<p>借助receive()方法可以从队列中获取一个Message对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Message message = rabbit.receive(<span class="string">"spittle.alert.queue"</span>);</span><br></pre></td></tr></table></figure>
<p>还可以配置默认消息队列</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">id</span> = <span class="string">"rabbitTemplate"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">exchange</span>=<span class="string">"spittle.alert.exchange"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">routing-key</span>=<span class="string">"spittle.alerts"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">queue</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spittle spittle = (Spittle) rabbit.receiveAndConvert(<span class="string">"spittle.alert.queue"</span>);</span><br></pre></td></tr></table></figure>
<p>receiveAndConvert()方法或使用和sendAndConvert() 相同的消息转换器，将Message转换成原始的类型</p>
<p>调用这两个方法都会立即返回结果，如果队列中没等待的消息，那结果就是null,这时候需要我们来管理轮询（polling）以及必要的线程，实现队列的监控</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/Spring消息/" data-id="cjz15dss600027opu9leazpdk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用SpringMVC创建REST" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/使用SpringMVC创建REST/" class="article-date">
  <time datetime="2019-08-06T11:58:14.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/使用SpringMVC创建REST/">使用SpringMVC创建REST</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>编写处理REST资源的控制器（替换 soap web 服务，更方便）</li>
<li>以XML、JSON以及其他格式表示资源</li>
<li><p>使用REST资源</p>
<p>1.REST与RPC不同，RPC是面向服务的，并且关注行为和动作，而REST则是面向资源，强调描述应用程序的事务和名词</p>
</li>
</ul>
<p>rest<strong>资源</strong>可以使用各种形式进行<strong>表述</strong>（representional），包括xml，json甚至html；使用rest的时候，我们更应该关注资源的<strong>状态</strong>（State而不是对资源采取的行为;rest资源数据<strong>转移</strong>，以某种形式转移到另一种应用。（其实REST就是将资源的状态以最合适客户端或者服务端的形式从服务端转移到客户端或者相反）注重<strong>事物</strong>不是行为。</p>
<p>2.Spring支持Rest的方式</p>
<p>​    1.控制器可以处理所有HTTP方法（主要get,put,post,delete）</p>
<p>​    2.借助<strong>@PathVariable</strong>注解，控制器能处理参数化的URL（将变量输入当成URL的一部分）</p>
<p>​    3.借助Spring视图和视图解析器，资源能够以多种方式进行描述，包括将数据模型渲染成XML，JSON，Atom以及RSS的view</p>
<p>​    4.可以使用ContentNegotiatingViewResolver来选择客户端表述</p>
<p>​    5.借助<strong>@ResponseBody</strong>注解和各种<strong>HttpMethodConverter</strong>实现，能替换基于视图的渲染方式也可以将传入的HTTP数据转化为传入控制器处理方法的Java对象。</p>
<p>​    6.借助RestTemplate，Spring应用能更方便地使用Rest资源</p>
<p>Spring的ContentNegotiatingViewResolver是一个特殊的视图解析器，配置方式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内容协商的两个步骤</p>
<p>1.确定请求的媒体类型</p>
<p>2.找到适合请求媒体的最佳视图</p>
<p>即使确定所请求媒体类型默认的策略，我们也可以通过设置ContentNegotiationManager去改变他的行为</p>
<p>有三种方式可以配置ContentNegotiationManager ，推荐后两种</p>
<ul>
<li>声明ContentNegotiationManager的bean</li>
<li>通过ContentNegotiationManagerFactoryBean间接创建bean</li>
<li>重载WebMvcConfigurerAdapter的configureContentNegotiation()方法</li>
</ul>
<p>xml配置最简方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"contentNegotiationManager"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.http.ContentNegotiationManagerFactoryBean"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultContentType</span>=<span class="string">"application/json"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>java配置最简方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span></span>&#123;</span><br><span class="line">    configurer.defaultContentType(MediaType.APPLICATION_JSON)；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面已经有了ContentNegotiationManagerbean,那么现在要将它注入到ContentNegotiatingViewResolver的</p>
<p>contentNegotiationManager属性中，修改ContentNegotiatingViewResolver的@Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">(ContentNegotiationManager cnm)</span></span>&#123;</span><br><span class="line">    ContentNegotiatingViewResolver cnvr = <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">    cnvr.setContentNegotiationManager(cnm);</span><br><span class="line">    <span class="keyword">return</span> cnvr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Http信息转换器</p>
<p>使用@ResponseBody注解，这样Spring会知道将返回的对象作为资源发送给客户端（以客户端想要的形式） ，而且DispatcherServlet会考虑到请求中Accept头部信息，并寻找合适的消息转换器</p>
<p>Jackson默认使用反射</p>
<p>使用@RequestBody，Spring会查看请求中的Content-Type头部信息，并寻找合适的消息转换器</p>
<p>Spring4.0之后使用<strong>@RestController</strong>注解，替换@Controller，就不需要每个方法添加@ResponseBody了，使用@RestController注解之后控制器，该方法返回的对象将会通过消息转换机制，产生客户端所需的资源表述</p>
<p>提供资源之外的其他内容</p>
<p>@ResponseBody提供了一种很有用的方式，能够将控制器返回的Java对象转换为客户端的资源表述，但是这个只是REST API一部分,还能提供额外的元数据。</p>
<p>Spring提供了多种方式处理</p>
<ul>
<li>@ResponseStatus可以指定状态码</li>
<li>控制器方法可以返回@ResponseEntity对象，该对象可以包含更多响应相关的元数据</li>
<li>异常处理器能够应对错误场景，这样处理器方法就能关注正常状况（@ExceptionHandler）</li>
</ul>
<p>编写REST客户端</p>
<p>举个栗子，我们借助FaceBook的Graph API来获取某人的FaceBook基本信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Profile <span class="title">fetchFaceBookProfile</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      	<span class="comment">//创建客户端</span></span><br><span class="line">        HttpClient client = HttpClient.createDefault();</span><br><span class="line">        <span class="comment">//创建请求</span></span><br><span class="line">        HttpGet request = <span class="keyword">new</span> HttpGet(<span class="string">"http://graph.facebook.com/"</span>+id);</span><br><span class="line">        request.setHeader(<span class="string">"Accept"</span>,<span class="string">"application/json"</span>);</span><br><span class="line">        <span class="comment">//执行请求</span></span><br><span class="line">        HttpResponse response = client.execute(request);</span><br><span class="line">        HttpEntity entity = response.getEntity();</span><br><span class="line">        <span class="comment">//将响应映射为对象</span></span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMappe();</span><br><span class="line">        <span class="keyword">return</span> mapper.readValue(entity.getContent(),Profile.class);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>了解RestTemplate//待续</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/使用SpringMVC创建REST/" data-id="cjz15dss6000a7opughbenmkv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用远程服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/使用远程服务/" class="article-date">
  <time datetime="2019-08-06T11:54:46.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/使用远程服务/">使用远程服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>访问和发布RMI服务</li>
<li>使用Hessian和Burlap服务</li>
<li>使用Spring的Hppt invoker</li>
<li>使用Spring开发Web服务</li>
</ul>
<p>spitter应用的服务层并使用RmiServiceExporter将服务发布为RMI服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterService</span></span>&#123;</span><br><span class="line">    <span class="function">Spitter get <span class="title">Spitter</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RmiServiceExporter <span class="title">rmiExporter</span><span class="params">(SpitterService spitterService)</span></span>&#123;</span><br><span class="line">   RmiServiceExporter rmiExporter = <span class="keyword">new</span> RmiServiceExporter();</span><br><span class="line">    <span class="comment">//RmiServiceExporter将POJO包装到服务适配器中，并将服务适配器绑定到RMI注册表中，从而将POJO转换为RMI服务</span></span><br><span class="line">    rmiExporter.setService(spitterService);</span><br><span class="line">    rmiExporter.setServiceName(<span class="string">"SpitterService"</span>);</span><br><span class="line">    rmiExporter.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="comment">//默认情况下，RmiServiceExporter会尝试绑定到本地机器1099端口上的RMI注册表，可以通过RegistryHost和ResitryPort来指定别的注册表</span></span><br><span class="line">    rmiExporter.setRegistryHost(<span class="string">"rmi.spitter.com"</span>);</span><br><span class="line">    rmiExporter.setRegistryPort(<span class="number">1199</span>);</span><br><span class="line">    <span class="keyword">return</span> rmiExporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Spring的RMiProxyFactoryBean是一个工厂bean，可以为RMI服务创建代理，只需配置Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RmiProxyFactoryBean <span class="title">spitterService</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RmiProxyFactoryBean rmiProxy = <span class="keyword">new</span> RmiProxyFactoryBean();</span><br><span class="line">    rmiProxy.setServiceUrl(<span class="string">"rmi://localhost/SpitterService"</span>);</span><br><span class="line">    rmiProxy.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="keyword">return</span> rmiProxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Spring的HttpInvoker,能执行基于Http的远程调用，并使用java的序列化机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpInvokerServiceExporter <span class="title">httpExportSpitterService</span><span class="params">(SpitterService service)</span></span>&#123;</span><br><span class="line">    HttpInvokerServiceExporter exporter= <span class="keyword">new</span> HttpInvokerServiceExporter();</span><br><span class="line">    expoerter.setService();</span><br><span class="line">    expoerter.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="keyword">return</span> exporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为HttpInvokerServiceExporter是个SpringMvc控制器，我们需要建立一个URL处理器，映射Http url到对应的服务上，就像Hession和Burlap导出器所做的一样。</p>
<p>HttpInvokerServiceExporter的工作方式是（请求进入之后，有DispatcherServlet分发到HttpInvokerServiceExporter，再调用serviceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HandlerMapping <span class="title">httpInvokerMapping</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SimpleUrlHandlerMapping mapping = <span class="keyword">new</span> SimpleUrlHandlerMapping();</span><br><span class="line">    Properties mappings = <span class="keyword">new</span> Properties();</span><br><span class="line">    mapping.setProperty(<span class="string">"/spitter.service"</span>,<span class="string">"httpExportedSpitterService"</span>);</span><br><span class="line">    mapping.setMapping(mappings);</span><br><span class="line">    <span class="keyword">return</span> mapping;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>映射设置xml</p>
<p>发布和使用web服务（使用jaxWsPortProxyFactory）</p>
<p>客户端调用service方法，JaxWsPortProxyFactoryBean 生成代理，代理传递soap消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JaxWsPorrtProxyFactoryBean spitterService&#123;</span><br><span class="line">	JaxWsPorrtProxyFactoryBean proxy = <span class="keyword">new</span> JaxWsPorrtProxyFactoryBean();</span><br><span class="line">    proxy.setWsdlDocument(<span class="string">"http://8080/services/Spitter?wsdl"</span>);</span><br><span class="line">    proxy.setServiceName(<span class="string">"spitterService"</span>);</span><br><span class="line">    proxy.setPortName(<span class="string">"spitterServiceHttpPort"</span>);</span><br><span class="line">    proxy.setInterface(<span class="string">"SpitterService.class"</span>);</span><br><span class="line">    proxy.setNamespaceUri(<span class="string">"http://spitter.com"</span>);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>减少使用远程服务。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/使用远程服务/" data-id="cjz15dssl000c7opu0kq92chc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-保护方法应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/保护方法应用/" class="article-date">
  <time datetime="2019-07-24T11:03:55.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/保护方法应用/">保护方法应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>保护方法调用</li>
<li>使用表达式定义安全规则</li>
<li>创建安全表达式计算器</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">注解</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">@preAuthorize</td>
<td style="text-align:left">在方法调动之前，基于表达式的计算结果来限制对方法的访问</td>
</tr>
<tr>
<td style="text-align:left">@PostAuthorize</td>
<td style="text-align:left">允许方法调用，如果表达式计算结果为false，则抛出一个安全性异常</td>
</tr>
<tr>
<td style="text-align:left">@PostFilter</td>
<td style="text-align:left">允许方法调用，但是必须按照表达式来过滤方法的结果</td>
</tr>
<tr>
<td style="text-align:left">@PreFilter</td>
<td style="text-align:left">允许方法调用，但是必须在进入方法前过滤输入值</td>
</tr>
</tbody>
</table>
<p>未完待续…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/保护方法应用/" data-id="cjz15dssl000g7opul401d7m1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-数据缓存" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/数据缓存/" class="article-date">
  <time datetime="2019-07-24T11:03:29.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/数据缓存/">数据缓存</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>启用声明式缓存</li>
<li>使用Ehance、Redis和gemFire实现缓存</li>
<li>注解驱动的缓存</li>
</ul>
<ol>
<li><p>启用对缓存的支持</p>
<p>Spring 对缓存的支持有两种方式</p>
<ol>
<li>注解驱动的缓存</li>
<li>XML声明的缓存</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>		<span class="comment">//启用缓存 （1，注解方式）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span></span>&#123;   <span class="comment">//声明缓存管理器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcurrentMapCacheManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache:annotation-driven</span>&gt;</span><span class="tag">&lt;/<span class="name">cache:annotation-driven</span>&gt;</span>  <span class="comment">&lt;!-- 启用缓存--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"cacheManager"</span> <span class="attr">class</span> = <span class="string">"org.springframeword.cache.concurrent.ConcurrentMapCacheManager"</span>  /&gt;</span>  <span class="comment">&lt;!--声明缓存管理器--&gt;</span></span><br></pre></td></tr></table></figure>
<p>@EnableCaching 和&lt;cache:annotation-driven /&gt; 工作方式相同，都是创建一个切面aspect去出发Spring缓存注解的切点pointcut,这个切面会从缓存中获取数据或者剔除数据 </p>
<p>配置<strong>EhCacheCacheManager</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>		<span class="comment">//启用缓存 （1，注解方式）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheCacheManager <span class="title">cacheManager</span><span class="params">(CacheManager cm)</span></span>&#123;   <span class="comment">//配置EhCacheCacheManager</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EhCacheCacheManager(cm);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheManagerFactoryBean <span class="title">ehcache</span><span class="params">()</span></span>&#123;  <span class="comment">//EhCacheManagerFactoryBean</span></span><br><span class="line">        EhCacheManagerFactoryBean ehCacheFactoryBean = </span><br><span class="line">            <span class="keyword">new</span> EhCacheManagerFactoryBean();</span><br><span class="line">        ehCacheFactoryBean.setConfigLaication(</span><br><span class="line">        	<span class="keyword">new</span> ClassPathResource(<span class="string">"com/sail/cache/ehcache.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> ehCacheFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span> <span class="comment">&lt;!--基础配置ehcache.xml--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span> = <span class="string">"spittleCache"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">maxBytesLocalHeap</span> = <span class="string">"50m"</span> </span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span> = <span class="string">"100"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>cacheManager()方法创建了一个EhCacheCacheManager的实例,这里其实要把CacheManager 给注入到EhCacheCacheManager中</p>
<p>使用<strong>Redis</strong>缓存（Spring Data Redis 提供了RedisCacheManager  ）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisTemplate redisTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisTemplate); <span class="comment">//Redis缓存管理器bean</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span></span>&#123;  <span class="comment">//Redis链接工厂bean</span></span><br><span class="line">        JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">        jedisConnectionFactory.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> jedisConnectionFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,String&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redidCF)</span>	</span>&#123; <span class="comment">//RedisTemplate bean</span></span><br><span class="line">        RedisTemplate&lt;String ,String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;String,String&gt;;</span><br><span class="line">        redisTemplate.setConnectionFactory(residCf);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为方法添加注解以支持缓存 ,,,也可以放到类上</p>
<p>@Cacheable和@Cacheput </p>
<p>这两者的区别是@Cacheable是会条件性触发 而带有@CachePut的注解方法始终都会被调用，方法返回值也会存在缓存中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(<span class="string">"spittleCache"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(</span><br><span class="line">        SELECT_SPITTLE_BY_ID, <span class="keyword">new</span> SpittleRowMapper(), id);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(EmptyResultDataAccessException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当findOne()被调用时，缓存切面会拦截调用并在缓存中查找以名为spittleCache存储的返回值，key是传递到findone中的id，如果没找到，就会调用这个方法并将返回值放到缓存之中。</p>
<p>使用<strong>XML</strong>声明缓存</p>
<p>要配置xml声明的环迅，需要创建Spring配置文件，这个文件中药包含cache和aop命名空间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span> <span class="comment">&lt;!--将缓存通知绑定到一个切点上--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span> = <span class="string">"cacheAdvice"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">pointcut</span> = <span class="string">"execution((* com.sail.spittr.db.SpittleRepository.*(..)))"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cache:advice</span> <span class="attr">id</span> = <span class="string">"cacheAdvice"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">cache:caching</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">cache:cacheable</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">method</span> = <span class="string">"findRecent"</span> /&gt;</span> <span class="comment">&lt;!--配置为支持缓存--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cache:cache-put</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span> </span></span><br><span class="line"><span class="tag">                         <span class="attr">method</span> = <span class="string">"save"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">key</span> = <span class="string">"#result.id"</span>/&gt;</span> <span class="comment">&lt;!--save是填充缓存--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cache:cache-evict</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span> </span></span><br><span class="line"><span class="tag">                           <span class="attr">method</span> = <span class="string">"remove"</span> /&gt;</span> <span class="comment">&lt;!--从缓存中移除--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache:caching</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache:advice</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"cacheManager"</span> <span class="attr">class</span> = <span class="string">"org.springframeword.cache.concurrent.ConcurrentMapCacheManager"</span>  /&gt;</span>  <span class="comment">&lt;!--声明缓存管理器，cache-advide中默认的是使用名为cacheManager--&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/数据缓存/" data-id="cjz15dssl000f7opuv6rd03k2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用NoSql数据库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/使用NoSql数据库/" class="article-date">
  <time datetime="2019-07-24T11:02:46.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/使用NoSql数据库/">使用NoSql数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用<strong>Spring Data MongoDB</strong>（1.通过注解实现对象-文档映射 2.使用MongoTemplate 实现基于模板的数据库访问 3.自动化运行时Repository生成）</p>
<p>1.借助@EnableMongoRepositories启用Spring Data MongoDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(<span class="string">"order.db"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMongoConfiguration</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDatabaseName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OrderDB"</span>; <span class="comment">//指定数据库名称</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MongoClient();  <span class="comment">//创建Mongo客户端</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.创建MongoClient来访问需要认证的MongoDB服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Enviroment env;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	MongoCredential credential = MongoCredential.createMongoCRCredential(</span><br><span class="line">    env.getProperty(<span class="string">"mongo.username"</span>),</span><br><span class="line">    <span class="string">"OrderDB"</span>,</span><br><span class="line">    env.getProperty(<span class="string">"mongo.password"</span>).toCharArray())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlns:mongo="http:www.springftameword.org/schema/data/mongo" <span class="comment">&lt;!-- 声明mongo命名空间--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mongo:repositories</span> <span class="attr">base-package</span>=<span class="string">"orders.db"</span>/&gt;</span>  <span class="comment">&lt;!-- 启用Repository 生成功能--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mongo:mongo</span> /&gt;</span> <span class="comment">&lt;!-- 声明 Mongo Client --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--创建MongoTemplate bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"mongoTemplate"</span>  </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframework.data.mongodb.core.MongoTemplate"</span></span></span><br><span class="line">      &lt;constructor-arg ref="mongo"/&gt;</span><br><span class="line">	  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"OrdersDB"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>MongoDB Repository </p>
<p>完全自定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderRepository extends MongoRepository&lt;Order ,String&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>OrderRepository扩展了MongoRepository因为Spring Data MongoDB 会自动实现Repository接口，所以会传递性地扩展Repository标记接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>（<span class="string">"&#123;'customer':'sailzjw' ,'type': ?0 &#125;"</span>）</span><br><span class="line"><span class="function">List&lt;Order&gt; <span class="title">findsailOrders</span><span class="params">(String s)</span></span>;</span><br></pre></td></tr></table></figure>
<p>@Query中给定的Json会与所有的Order文档进行匹配，并返回匹配的文档，这里type 属性映射成”?0” 表示type属性应该与查询方法的第0个参数相等，如果有多个参数的话，可以通过 ?1 ?2 方式引用</p>
<p>混合自定义</p>
<p>1定义中间接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">orderOperations</span></span>&#123;</span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">findOrderByType</span><span class="params">(String t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 将自定义Repository功能注入到自动生成的Repository中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">OrderPoerations</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoOperations mongo; <span class="comment">// 注入MongoOperations </span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findOrdersByType</span><span class="params">(String t)</span></span>&#123;</span><br><span class="line">        String type = t.equals(<span class="string">"NET"</span>) ? <span class="string">"WEB"</span> : t;</span><br><span class="line">        Criteria where = Criteria.where(<span class="string">"type"</span>).is(t);<span class="comment">//创建查询</span></span><br><span class="line">        Query query = Query.query(where);</span><br><span class="line">        <span class="keyword">return</span> mongo.find(query ,Order.class); <span class="comment">//执行查询</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>混合实现中注入了MongoOperations (也就是MongoTemplate所实现的接口)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderRepository extends MongoRepository&lt;Order ，String&gt;， orderOperations&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 修改OrderRepository 让其实现OrderOperations</p>
<p>使用<strong>Redis操作key-value</strong>数据 （HashMap）</p>
<p> <strong>RedisTemplate</strong> 和 <strong>StringRedisTemplate</strong></p>
<p>假设已经有RedisConnectionFactory 那么用如下方式构建RedisTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">RedisTemplate&lt;String ,Product&gt; redis = <span class="keyword">new</span> RedisTemplate&lt;String ,Product&gt;;</span><br><span class="line">redis.setConnectionFactory(cf);</span><br></pre></td></tr></table></figure>
<p>如果key-value都是String类型，那么就可以使用StringRedisTemplate来代替RedisTemplate</p>
<p>StringRedisTemplate有一个接受RedisConnectionFactory的构造器，因此没必要在构建后在调用setConnectionFactory()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">StringRedisTemplate redis = <span class="keyword">new</span> StringRedisTemlate(cf)</span><br></pre></td></tr></table></figure>
<p> 序列化</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/使用NoSql数据库/" data-id="cjz15dssl000d7opu9q1fouxb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用ORM持久化数据" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/使用ORM持久化数据/" class="article-date">
  <time datetime="2019-07-17T13:02:14.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/使用ORM持久化数据/">使用ORM持久化数据</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> 一些特性：1，延迟加载 2，预先抓取 3，级联</p>
<p>spring对持久化框架的集成附加服务：1，支持Spring声明式事务 2，透明的异常处理 3，线程安全的轻量级模板类  4，DAO支持类 5，资源管理</p>
<ol>
<li><p>在Spring中集成Hibernate</p>
<p>1.1声明Hibernate的Session工厂</p>
<p>LocalSessionFactoryBean， AnnotationSessionFactoryBean</p>
<p> 使用 Hibernate Session实现不依赖于Spring的Repository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HibernateSpitterRepository</span><span class="params">(SessionFactory sessionFactory)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sessionFactory = sessionFactory; <span class="comment">//注入SessionFactory</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Session <span class="title">currentSession</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sessionFactory.getCurrentSession();<span class="comment">//从SessionFactory中获取当前Session</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">count</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> findAll().size();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">save</span><span class="params">(Spitter spitter)</span></span>&#123;</span><br><span class="line">    Serializable id = currentSession().save(spitter); <span class="comment">//使用当前Session</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Spitter(</span><br><span class="line">    (Long) id,</span><br><span class="line">    spitter.getUsername()，</span><br><span class="line">    spitter.getPassword(),</span><br><span class="line">    spitter.getEmail());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Spitter) currentSession().get(Spitter.class, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">findByUsername</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Spitter) currentSession()</span><br><span class="line">        .createCriteria(Spitter.class)</span><br><span class="line">        .add(Restriction.eq(<span class="string">"username"</span>,username))</span><br><span class="line">        .list().get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Spitter&gt; <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (List&lt;Spitter&gt;) currentSession()</span><br><span class="line">        .createCriteria(Spitter.class).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：1.这里得先通过@Inject注解让Spring将一个SessionFactory注入到HibernateSpitterRepository的sessionFatory属性中，在currentSession()方法中使用SessionFactory来获取当前事务的Session</p>
<p>​    2.也使用了@Repository注解，作用：1，构造性注解，能被Spring组件扫描所扫描到，这样不用声明bean   2， 捕获平台相关异常，然后使用Spring统一非检查型异常的形势重新抛出</p>
<p>不使用Spring模板的<strong>纯Jpa Repository</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRspository</span></span>&#123;</span><br><span class="line">   <span class="meta">@PersistenceUnit</span></span><br><span class="line">    <span class="keyword">private</span> EntityManagerFacotory emf; <span class="comment">//注入EntityManagerFactory </span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span></span>&#123;</span><br><span class="line">        emf.createEntityManager().persist(spitter)  <span class="comment">//创建并使用EntityManager</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>借助 Spring  Data 实现自动化的Jpa Repository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Spitter</span>, <span class="title">Long</span> &gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p> 配置Spring Data Jpa (xml 方式配置)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jpa:repositories</span> <span class="attr">base-package</span>=<span class="string">"com.habuma.spittr.db"</span></span></span><br></pre></td></tr></table></figure>
<p>java 方式配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages=<span class="string">"com.habuma.spittr.db"</span>)   <span class="comment">//关键注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfigutation</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
<p>​</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/17/使用ORM持久化数据/" data-id="cjz15dssl000b7opul8n77d4n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring和jdbc操作数据库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/spring和jdbc操作数据库/" class="article-date">
  <time datetime="2019-07-17T13:01:41.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/spring和jdbc操作数据库/">spring和jdbc操作数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.基于JDBC 驱动的数据源</p>
<p>​    1.<strong>DriverManagerDataSource</strong> : 每个链接请求时都会返回一个新的连接，没有进行池化管理</p>
<p>​    2.SimpleDriverDataSource ： 和1类似，直接使用JDBC驱动，解决特定环境下的类加载问题</p>
<p>​    3.SingleConnectionDataSource:  每个请求返回同一个连接</p>
<p>使用jdbc操作数据库太繁琐，后使用模板操作</p>
<p>​    1.<strong>JdbcTemplate</strong></p>
<p>​    2.NamedParameterJdbcTemplate</p>
<p>​    3.SimpleJdbcTemplate</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/17/spring和jdbc操作数据库/" data-id="cjz15dss600057opuo82a0lto" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-spring-security" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/spring-security/" class="article-date">
  <time datetime="2019-07-17T13:00:04.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/spring-security/">spring security</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作用：保护web应用</p>
<p>通过重载WebSecurityConfigurerAdatper 中的一个或者多个方法来实现（1，configure（WebSecurity） 重载配置Spring Security()的 Filter链   2，configure（HttpSecurity） 重载配置如何通过拦截器保护请求  3,configure（AuthenticationManagerBuilder)  通过重载， 配置user-detail服务）</p>
<p>为SpringMvc启用Web安全性功能简单配置configure(HttpSecurity) </p>
<blockquote>
<p>这个配置指定如何保护http请求，以及客户端认证方案，通过authorizeRequests()和anyRequest().authenticated() 就会进入应用的Http请求都要认证，它也配置security基于表单登录以及Http Basic方式的认证。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvcSecurity</span>  <span class="comment">//还配置了参数解析器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> throw Exception</span>&#123;</span><br><span class="line">    	http.authorizenRequests().anyRequest().authenticated()</span><br><span class="line">        .and().formLogin().and().httpBasic();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有重载configure(AuthenticationManagerBuilder)方法，所以没有用户存储支撑认证过程，没有用户存储，就是没有用户，这里所有的请求都要认证，所以没人能够登录成功</p>
</blockquote>
<p>添加 Spring Security 配置</p>
<ol>
<li>配置用户存储</li>
<li>指定哪些请求需要认证， 哪些请求不认证，以及权限</li>
<li>提供自定义登陆页面，替换原来的默认登录页面</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvcSecurity</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBUilder</span></span></span><br><span class="line"><span class="function"><span class="params">                             auth)</span> throw Exception</span>&#123;</span><br><span class="line">        <span class="comment">//启用内存用户存储，适用于测试和开发， 生产中更适合使用数据库保存</span></span><br><span class="line">    	auth.inMemoryAuthentication()  </span><br><span class="line">            .withUser(<span class="string">"user"</span>).password(<span class="string">"password"</span>).roles(<span class="string">"USER"</span>).and()</span><br><span class="line">            .withUser(<span class="string">"admin"</span>).password(<span class="string">"password"</span>).roles(<span class="string">"USER"</span>，<span class="string">"ADMIN"</span>)；</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于数据库表进行认证, 然后配置一个数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DataSource dataSource；</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> configure（AuthenticationManagerBuilder auth) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">	auth.jdbcAuthentication().dataSource(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于密码</p>
<blockquote>
<p>passwordEncoder()方法可以接受Security中 passwordEncoder接口的任意实现。</p>
</blockquote>
<p>启用HttpBasic认证典型配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity hppt)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    http.formLogin().loginPage(<span class="string">"/login"</span>)</span><br><span class="line">        .and().httpasic().realmName(<span class="string">"Spittr"</span>)</span><br><span class="line">        .and()</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/17/spring-security/" data-id="cjz15dss600047opu57idr6u0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/07/使用WebSocket和STMOP实现消息功能/">使用WebSocket和STMOP实现消息功能</a>
          </li>
        
          <li>
            <a href="/2019/08/06/Spring消息/">Spring消息</a>
          </li>
        
          <li>
            <a href="/2019/08/06/使用SpringMVC创建REST/">使用SpringMVC创建REST</a>
          </li>
        
          <li>
            <a href="/2019/08/06/使用远程服务/">使用远程服务</a>
          </li>
        
          <li>
            <a href="/2019/07/24/保护方法应用/">保护方法应用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 启航<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>