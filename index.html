<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>启航的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="启航的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="启航的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="启航的博客">
<meta name="twitter:description" content="hello world">
  
    <link rel="alternate" href="/atom.xml" title="启航的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">启航的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">很高兴遇见你</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-深入浅出mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/25/深入浅出mysql/" class="article-date">
  <time datetime="2019-08-25T09:40:10.000Z" itemprop="datePublished">2019-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/25/深入浅出mysql/">深入浅出mysql</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Sql基础</strong></p>
<p>1.登录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; mysql -uroot -proot;</span><br></pre></td></tr></table></figure>
<p>DDL语句：数据定义语言，这些语句定义了不同的数据段、数据库、表、列、索引等数据库对象的定义。常用的语句关键字主要包括 create、drop、alter等。 </p>
<p>1.查看所有数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>；</span><br></pre></td></tr></table></figure>
<p>2.切换数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> dbname</span><br></pre></td></tr></table></figure>
<p>3.查看数据库所有表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure>
<p>4.查看表信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc  tablename;(<span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span>  tbname;)</span><br></pre></td></tr></table></figure>
<p>5.创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbname( column_name_1  column_type_1 <span class="keyword">constraints</span>, column_name_2  column_type_2 <span class="keyword">constraints</span> ) ;</span><br></pre></td></tr></table></figure>
<p>6.删除表 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> tbname;</span><br></pre></td></tr></table></figure>
<p>7.以员工表(emp)为例 修改表字段属性 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">MODIFY</span> [<span class="keyword">COLUMN</span>] column_definition [<span class="keyword">FIRST</span> | <span class="keyword">AFTER</span> col_name]   </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp **<span class="keyword">modify</span>** ename <span class="built_in">varchar</span>(<span class="number">20</span>) ；</span><br></pre></td></tr></table></figure>
<p>  8.添加字段 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">ADD</span> [<span class="keyword">COLUMN</span>] column_definition [<span class="keyword">FIRST</span> | <span class="keyword">AFTER</span> col_name] </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span>  emp  **<span class="keyword">add</span> <span class="keyword">column</span>** age ing(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>9.删除字段</p>
<blockquote>
<p>ALTER TABLE tablename DROP [COLUMN] col_name  </p>
</blockquote>
<blockquote>
<p>alter table emp drop column age; </p>
</blockquote>
<p>10.修改表字段名 (区分表字段属性 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">CHANGE</span> [<span class="keyword">COLUMN</span>] old_col_name column_definition [<span class="keyword">FIRST</span>|<span class="keyword">AFTER</span> col_name] </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">change</span> age age1 <span class="built_in">int</span>(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>11.修改字段排序</p>
<p>在ename后面添加birth字段   属性为date</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">add</span> birth <span class="built_in">date</span>  **<span class="keyword">after</span>** ename;</span><br></pre></td></tr></table></figure>
<p>把age 字段放到最前面</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">modify</span> age <span class="built_in">int</span>(<span class="number">13</span>) <span class="keyword">first</span>;</span><br></pre></td></tr></table></figure>
<p>把age 放到ename后面</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">modify</span> age <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">after</span> ename;</span><br></pre></td></tr></table></figure>
<p>12.修改表名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">RENAME</span> [<span class="keyword">TO</span>] new_tablename </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">rename</span> emp1;</span><br></pre></td></tr></table></figure>
<p>DML语句：数据操纵语句，用于添加、删除、更新和查询数据库记录，并检查数据完整性，常用的语句关键字主要包括 insert、delete、udpate 和select 等。 </p>
<p>1.插入记录（如果属性名和属性值对应，可以省略属性名；  可以 插入多条记录，以逗号隔开；对于含可空字段、非空但是含有默认值的字段、自增字段 ）  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tablename (field1,field2,……fieldn) <span class="keyword">VALUES</span>(value1,value2,……valuesn); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp (ename,sal) <span class="keyword">values</span> (<span class="string">'sail'</span>,<span class="string">'1'</span>);</span><br></pre></td></tr></table></figure>
<p>2.更新记录（可同时更新多张表）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span>  emp **<span class="keyword">set</span>**  sal  =  <span class="number">111</span> <span class="keyword">where</span> ename = <span class="string">'sail'</span>;</span><br></pre></td></tr></table></figure>
<p>3.删除记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tablename [<span class="keyword">WHERE</span> CONDITION] </span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename = <span class="string">'hh'</span>;</span><br></pre></td></tr></table></figure>
<p>4.查询记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tablename [<span class="keyword">WHERE</span> CONDITION]</span><br></pre></td></tr></table></figure>
<p> 查询不重复记录 (where 条件在 <strong>group by</strong> 之前   , <strong>distinct</strong>)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  <span class="keyword">distinct</span>  deptno <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">select</span> deptno <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> emp;</span><br></pre></td></tr></table></figure>
<p>条件查询 null 值不能通过&lt;&gt; 判断，只能is (not) null</p>
<p> 排序和限制（order by）  默认为升序 asc</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tablename [<span class="keyword">WHERE</span> CONDITION] [<span class="keyword">ORDER</span> <span class="keyword">BY</span> field1 [<span class="keyword">DESC</span>|<span class="keyword">ASC</span>] ， field2</span><br><span class="line">[<span class="keyword">DESC</span>|<span class="keyword">ASC</span>]，……fieldn [<span class="keyword">DESC</span>|<span class="keyword">ASC</span>]] </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> sal &gt;<span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> deptno ,sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p>对于排序后的记录，如果希望只显示一部分 ，可以用limit（从第二条记录起展示3条记录 limit 1,3）默认的起始量是0</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ……[<span class="keyword">LIMIT</span> offset_start,<span class="keyword">row_count</span>]</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>通常<strong>limit</strong> 和 <strong>order by</strong> 一起使用进行分页展示</p>
<p>聚合</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [field1,field2,……fieldn] fun_name</span><br><span class="line"><span class="keyword">FROM</span> tablename</span><br><span class="line">[<span class="keyword">WHERE</span> where_contition]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> field1,field2,……fieldn</span><br><span class="line">[<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</span><br><span class="line">[<span class="keyword">HAVING</span> where_contition]</span><br></pre></td></tr></table></figure>
<p>fun_name : 表示要做的聚合操作，也就是聚合函数，sum(),count(),max(), min()</p>
<p>group by : 表示要进行分类聚合的字段，</p>
<p>with rollup： 表明是否对分类聚合后的结果进行再汇总</p>
<p>having: 关键字表示对分类后的结果再进行条件的过滤</p>
<p>tip：having 和 where 的区别在于 having 是对聚合后的结果进行条件的过滤，而 where 是在聚合前就对记录进行过滤，如果逻辑允许，我们尽可能用 where 先过滤记录，这样因为结果集减小，将对聚合的效率大大提高，最后再根据逻辑看是否用 having 进行再过滤。</p>
<p>表连接:分为内连接和外连接 ，外连接又分成左连接 和右连接(左连接就是左边是全数据 )</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ename,deptname <span class="keyword">from</span> emp <span class="keyword">left</span> <span class="keyword">join</span> dept <span class="keyword">on</span> emp.deptno=dept.deptno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> ename,deptname <span class="keyword">from</span> dept <span class="keyword">right</span> <span class="keyword">join</span> emp <span class="keyword">on</span> dept.deptno=emp.deptno;</span><br></pre></td></tr></table></figure>
<p>连接查询通常用来优化子查询</p>
<p>记录联合（union 和 union all ）</p>
<p>union all 是把结果直接和并 ，union是将 union all 后的结果进行一次distinct，去除重复记录后的结果（这里注重的是结果的合并）</p>
<p>DCL语句：数据控制语句，用于控制不同数据段直接的许可和访问级别的语句。这些语句定义了数据库、表、字段、用户的访问权限和安全级别。主要的语句关键字包括 grant、revoke 等。 </p>
<p><strong>开发篇</strong></p>
<p>1.表类型（存储引擎）的选择</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'table_type'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'have%'</span>;</span><br></pre></td></tr></table></figure>
<p>MyISAM</p>
<p>mysql默认的存储引擎，不支持事务和外键，优点访问速度快</p>
<p>InnoDB</p>
<p>提供了具有提交，回滚和崩溃回复能力的事务安全，支持外键，写的速度较慢，</p>
<p>自增序列(必定是索引，如果是组合索引也肯定是首列)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">last_insert_id</span>();</span><br></pre></td></tr></table></figure>
<p>外键约束 (可以在建表的时候做一些操作上的限制)</p>
<p>在导入多个表数据的时候，可以暂时关闭外键约束的检查，在load data和alter table的时候也可以通过暂时关闭外键约束来提高处理速度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#关闭</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 0; </span><br><span class="line">#打开</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br></pre></td></tr></table></figure>
<p> innodb存储表和索引有以下两种方式 ，表结构保存在.frm </p>
<ul>
<li>使用共享表空间存储 数据和索引保存在dir和path定义的表空间中</li>
<li>使用更多表空间存储  数据和索引保存在 .ibd   需要设置参数 innodb_file_per_table，并重新启动服务后<br>才可以生效 </li>
</ul>
<p>MEMORY</p>
<p>存储引擎使用存在内存中的内容来创建表 ，每个表对应一个磁盘文件，访问迅速，但是关闭数据库，数据就会消失</p>
<p>MERGE</p>
<p>是myisam表的组合，MERGE 表在磁盘上保留两个文件，文件名以表的名字开始，一个.frm 文件存储表定义，<br>另一个.MRG 文件包含组合表的信息 </p>
<p>2.数据类型的挑选</p>
<p>char长度固定，varchar长度不固定 ，除了InnoDB用varchar之外（支持行级锁），其他推荐char</p>
<p>text和blob ： text只能保存字符数据  ， blob能保存二级制数据，在删除操作时会用性能影响，所以使用optimize table来优化表</p>
<p>小结：</p>
<p>1.对于字符类型，要根据存储引擎来进行相应的选择。<br>2.对精度要求较高的应用中，建议使用定点数来存储数值，以保证结果的准确性。<br>3.对含有 TEXT 和 BLOB 字段的表，如果经常做删除和修改记录的操作要定时执行OPTIMIZE TABLE 功能对表进行碎片整理。<br>4.日期类型要根据实际需要选择能够满足应用的最小存储的日期类型。 </p>
<p>3.字符集 ：utf-8mb4</p>
<p>4.索引的设计和使用</p>
<p>5.存储过程</p>
<p>6.事务控制和锁定语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 表film_text 获得表锁 ，其他表读的时候就得等待</span></span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">tables</span> film_text <span class="keyword">read</span> ; </span><br><span class="line"><span class="comment"># 释放表锁</span></span><br><span class="line"><span class="keyword">unlock</span> <span class="keyword">tables</span> ；</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> 或 <span class="keyword">begin</span> 可以开始一项新事务</span><br><span class="line"><span class="keyword">commit</span>用来提交事务 </span><br><span class="line"><span class="keyword">rollback</span> 用来回滚事务</span><br><span class="line"><span class="keyword">chain</span> 和<span class="keyword">release</span> 分表用来定义在事务提交或者回滚之后的操作， <span class="keyword">chain</span>会立即启动新事务，冰河刚才事务有相同隔离级别，<span class="keyword">release</span>则会断开和客户端的连接</span><br></pre></td></tr></table></figure>
<p>7.分布式事务的使用</p>
<p>使用分布式事务：涉及一个或多个资源管理器和一个事务管理器 </p>
<ul>
<li>资源管理器（RM）用于提供通向事务资源的途径 </li>
<li>事务管理器（TM）用于协调作为一个分布式事务一部分的事务 </li>
</ul>
<p>8.sql安全问题</p>
<ul>
<li>采用预编译（preparedstatement）防止</li>
<li>自定义函数检验或者 使用应用程序提供的转换函数</li>
</ul>
<p>9.sql mode</p>
<p>10.sql优化</p>
<p> a.先查看各种sql的执行频率</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Com_%'</span>;</span><br></pre></td></tr></table></figure>
<p>b.定位执行效率低的sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span></span><br></pre></td></tr></table></figure>
<p>c. 通过<strong>explain</strong>分析低效sql的执行计划</p>
<p>11.使用索引</p>
<p>a.<strong>创建符合索引</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> ind_ename_sal <span class="keyword">on</span> emp (ename, sal);</span><br></pre></td></tr></table></figure>
<p>1.使用联合索引查询的话，会使用前列的索引，如果只用后面的sal 则不会走索引</p>
<p>2.使用like 查询， 后面是常量并且只有% 不在第一个字符才会走所以</p>
<p>3.对大文本进行搜索， 使用全文索引而不用 like ‘% …%’</p>
<p>4.如果列名是索引，那么使用 column_name  is null 将使用索引</p>
<p>b.<strong>存在索引但不使用</strong></p>
<p>1.如果mysql 觉得使用索引比全表扫描慢，则不用索引</p>
<p>2.memory、heap表中只有where 条件中使用= 进行索引列 ，才能使用索引</p>
<p>3.用or分割的条件，or前的条件中的列有索引，后面的列中没索引，那么涉及到的索引都不会被用到 </p>
<p>4.如果列类型是字符串，那么在where 条件中要把字符用’’引起来才能走索引</p>
<p>c<strong>.查看索引的使用情况</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Handler_read%'</span>;</span><br></pre></td></tr></table></figure>
<p>通过handler_read_key的高低判断是否走索引，很高就是在走索引</p>
<p>Handler_read_rnd_next  值很高表示查询效率低，应该立刻建索引</p>
<p>12.简单优化</p>
<p>a.定期分析表和检查表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">analyze</span> <span class="keyword">table</span> emp;</span><br><span class="line"><span class="keyword">check</span> <span class="keyword">table</span> emp;</span><br></pre></td></tr></table></figure>
<p>b.定期优化表 (提示 recreate + analyze  instead …)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">optimize</span> <span class="keyword">table</span> emp;</span><br></pre></td></tr></table></figure>
<p>13.常用sql的优化</p>
<p>a.大批量插入数据  </p>
<p>myisam 引擎 使用load加载数据时可以先禁用key</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">disable</span> <span class="keyword">keys</span>;</span><br><span class="line">loading the data</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_name <span class="keyword">enable</span> <span class="keyword">keys</span>;</span><br></pre></td></tr></table></figure>
<p>innodb 1，按主键顺序导入 2，在导入数据前执行 set unique_checks=0,关闭唯一校验 3， set autocommit = 0,关闭自动提交</p>
<p>b.优化insert语句</p>
<p> 1.使用批插  2.如果不同客户插入很多行，能通过insert delayed语句来得到更高的速度 3.将索引文件和数据文件分在不同的磁盘上存放 4.批插使用bulk_insert_buffer_size (支队myisam使用) 5.从文件装载表时，使用load data infile会提高效率</p>
<p>c.优化group by 语句</p>
<p> group by null 可以优化</p>
<p>d.优化order by 语句</p>
<p>where 条件和 order by 使用相同的索引</p>
<p>e.优化嵌套查询</p>
<p>join 替代子查询</p>
<p>f.or条件优化</p>
<p>必须所有的条件都用索引才生效</p>
<p>g.使用sql提示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp  <span class="keyword">use</span> <span class="keyword">index</span> ename <span class="keyword">where</span> ename =<span class="string">'sail'</span>;</span><br></pre></td></tr></table></figure>
<p> use/ignore/force  index</p>
<p>14.优化数据库对象</p>
<p> a.优化表数据类型</p>
<p> b. 通过拆分表提高表的访问效率</p>
<p>  第一种是垂直拆分：数据行变小，一个数据页能存更多东西， 查询时就会减少i/o次数 </p>
<p>  第二种是水平拆分：1. 表很大，分割后可以降低查询时需要读的数据和索引的页数，同时降低了索引层数，提高了查询速度 2. 表数据有独立性，例如不同区域的不同时期数据 3.需要把数据存到不同介质上</p>
<p> c.使用中间表提高查询速度（中间表的结构和之前的表完全一样）</p>
<p>15.锁问题</p>
<p>表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低 </p>
<p>行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高 </p>
<p>页面锁：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般 </p>
<p> myisam 表锁</p>
<p>查看表级锁争用情况 ，Table_locks_waited 的值比较高，则说明存在着较严重的表级锁争用情况 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'table%'</span>;</span><br></pre></td></tr></table></figure>
<p>添加表锁，myisam会自动给涉及的表查询 加读锁 ，更新，删除，插入添加写锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> emp write;</span><br><span class="line">表write锁定 ，则其他session无法查询，本session无所谓</span><br><span class="line"><span class="keyword">unlock</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>
<p>myisam是串行并发，有个系统变量是concurrent_insert ，用来控制并发插入的行为，其值为 0时（不支持并发插入）,为1时（当一个进程读表时，另一个进程从表位插入）,为2时（无论怎样都能在表尾并发插入）</p>
<p>myisam的锁调度，读锁和写锁是互斥的，读写操作是串行的 ，如果两个进程请求一个myisam表的读锁和写锁，那么mysql则让写进程先获得锁</p>
<p>设置low-priority-updates 可以降低写的优先级</p>
<p><strong>InnoDB</strong>锁问题</p>
<p>一是支持事务（TRANSACTION）；二是采用了行级锁 </p>
<p> a.事务以及acid属性</p>
<p> 原子性：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。 </p>
<p>一致性 ：在事务开始和完成时，数据都必须保持一致状态。 </p>
<p>隔离性 ：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行 。</p>
<p>持久性 ：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持 。</p>
<p>隔离性的实现原理就是锁   </p>
<p>innodb中实现了如下两种 行级锁</p>
<p>a.共享锁(读锁 s lock) ，允许事务读一行数据，阻止其他事务获得相同数据集的排他锁  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_name <span class="keyword">where</span> ... <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br></pre></td></tr></table></figure>
<p>b.排他锁(写锁 x lock)，允许获得排他锁的事务更新一行数据，阻止其他事务取得相同数据集的共享<br>读锁和排他写锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb_name <span class="keyword">where</span> ... <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>
<p>InnoDB支持两种意向锁（即为表级别的锁）：</p>
<p>a.意向共享锁（读锁 IS Lock），事务想要获取一张表的几行数据的共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。</p>
<p>b.意向排他锁（写锁 IX Lock），事务想要获取一张表中几行数据的排它锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁。</p>
<p>四种隔离级别  MVCC </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> tx_isolation = <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<p>a.可序列化 serializable： session a 操作数据库,session b 插入数据超时</p>
<p>b.可重复读 repeatable read:  一个事务按相同的查询条件读以前的数据，其他事务插入了满足条件的新数据，产生幻读    (InnoDB存储引擎在RR隔离级别下，已经使用Next-Key Lock算法避免了幻读。) 就是 读出来的数据还是最初的版本</p>
<p>c.读已提交  read committed: 事务从开始直到提交之前，所做的任何修改对其他事务都是不可见的。（commit之后才更新数据）</p>
<p>d.读未提交 read uncommited: 事务中的修改，即使没有提交，对其他事务也都是可见的。（实时更新）</p>
<p>原子性、一致性、持久性</p>
<p>redo 和 undo</p>
<p>脏读：一个事务在对一个记录修改，在这个事务完成并提交前，这条记录的数据就处于不一致的状态，另一个事务也来读同一记录，这就是脏读</p>
<p>不可重复读:一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了</p>
<p>幻读：一个事务按相同的查询条件重新读取以前检索过的数据，其他事务插入了满足其查询条件的新数据。</p>
<p>获取InnoDB行锁争用情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'innodb_row_lock%'</span>;</span><br></pre></td></tr></table></figure>
<p>如果发现锁争用比较严重，如 InnoDB_row_lock_waits 和 InnoDB_row_lock_time_avg 的值比较高，还可以通过设置 InnoDB Monitors 来进一步观察发生锁冲突的表、数据行等，并分析锁争用的原因 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table innodb_monitor(a int) engine = innodb;</span><br><span class="line">mysql&gt; show innodb status\g;</span><br><span class="line">mysql&gt; drop table innodb_monitor;</span><br></pre></td></tr></table></figure>
<p>InnoDB的行锁模式以及加锁方法</p>
<p>行锁实现方式：</p>
<p>a.在不通过索引条件查询的时候，InnoDB用的是表锁，而不是行锁。这时候session a 如果请求排他锁之后，session b会等待</p>
<p>b.行锁是针对索引加的锁，不是针对记录加的锁，所以虽然是访问不同行记录，但是如果使用相同的索引键，实惠出去锁冲突的</p>
<p>c.当表有多个索引的时候，不同的事务可以使用不同的索引锁定不同的行，innodb会使用行锁来对数据加锁</p>
<p>d.即使条件中使用了索引字段，但是mysql会判断是全表扫描还是走索引</p>
<p>间隙锁：（next-key 锁）</p>
<p>a.防止幻读</p>
<p>b.为了满足其恢复和复制的需要</p>
<p>如何控制间隙锁开启和关闭</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br><span class="line">添加</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_locks_unsafe_for_binlog=on</span><br></pre></td></tr></table></figure>
<p>但是会是的binlog日志出问题，一般不推荐使用</p>
<p>非要使用的话，“select * from source_tab … Into outfile”和“load data infile …”语句组合来间接实现，采用这种方式 MySQL 不会给 source_tab 加锁。 </p>
<p>死锁：两个事务都需要获得对方持有的排他锁才能继续完成事务，这种循环锁等待 </p>
<p>优化：1、不同程序并发存取多个表，约定相同的顺序来访问表</p>
<p>​        2、在程序以批量方式处理数据的时候，如果实现对数据排序，保证线程按固定顺序处理记录，也可以降低死锁概率</p>
<p>​       3、在事务中，如果要更新记录，应该直接申请足够级别的锁，即排他锁，而不应先申请共享锁，更新时再申请排他锁 </p>
<p>​       4、 repaetable read –&gt; read committed</p>
<p>​             5、read committed  时执行 select … for update  则可捕获异常之后rollback释放获得的排他锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">innodb</span> <span class="keyword">status</span>;命令来确定最后一个死锁产生的原因</span><br></pre></td></tr></table></figure>
<p>16.优化mysql server</p>
<p>查看服务器参数值： show variables;</p>
<p>查看服务器运行状态值： show status;</p>
<p>查看参数的详细定义：mysqld –verbose –help|more </p>
<p>影响mysql 性能的重要参数</p>
<p>a.    key_buffer_size  的设置 :此参数用来设置索引块缓存的大小，被所有线程共享，只适用于myisam引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> hot_cache2.key_buffer_size = <span class="number">128</span>*<span class="number">1024</span>;</span><br></pre></td></tr></table></figure>
<p>设置global之后缩影的新连接，都会生效。</p>
<p>然后把相关 表的索引放到指定的索引缓存中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cache</span> <span class="keyword">index</span> sale ,sale2 <span class="keyword">in</span> hot_cache2;</span><br></pre></td></tr></table></figure>
<p> 把索引预装到默认的key_buffer 中，可以使用load index into cache   tbname 语句</p>
<p>通过如下与删除索引缓存</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> hot_cache2.key_buffer_size = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>b. table_cache设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">flush</span> <span class="keyword">tables</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'open_tables'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> t;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'open_tables'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> t;</span><br></pre></td></tr></table></figure>
<p>c. innodb_buffer_pool_size的设置 :该参数表示InnoDB  存储引擎的表数据和索引数据的最大内存缓冲区大小 </p>
<p>d.innodb_flush_log_at_trx_commit 设置：该参数用来控制缓冲区中的数据写入到日志文件以及日志文件数据刷新到磁盘的操作时机 </p>
<p>e.innodb_additional_mem_pool_size 设置：这个参数是 InnoDB 存储引擎用来存储数据库结构和其他内部数据结构的内存池的大小，其默认值是 1MB 。应用程序的表越多，则在这里要分配越多内存</p>
<p>f.innodb_lock_wait_timeout 的设置 :该参数主要被用于在出现死锁情况的时候等待指定的时间后回滚 </p>
<p>g.innodb_log_buffer_size 的设置 :日志缓存的大小 ,通常设置为 8～16MB 就足够了。越小的系统它的值越小。系统默认值是 1MB</p>
<p>h. innodb_log_file_size 的设置 :该参数含义是一个日志组（log group）中每个日志文件的大小 ,在高写入负载尤其是大数据集的情况下很重要。这个值越大则性能相对越高，但是带来的副作用是，当系统灾难时恢复时间会加大。系统默认值是 5MB </p>
<p>17.磁盘i/o问题</p>
<p>raid</p>
<p>18.应用优化</p>
<p>a.使用连接池</p>
<p>b.减少对数据库的访问</p>
<p>​    b1 .避免对同一数据做重复检索</p>
<p>​    b2.使用查询缓存</p>
<p>​    b3.增加cache层</p>
<p>c.负载均衡：是实际应用中使用非常普遍的一种优化方法，它的机制就是利用某种均衡算法，将固定的负载量分布到不同的服务器上，以此来减轻单台服务器的负载 </p>
<p>​    c1.利用mysql的主从赋值有效分离更新和查询操作</p>
<p>​    c2.采用分布式数据库架构</p>
<p>d.表的字段尽量不使用自增长变量 </p>
<p>对于没有删除行操作的 MyISAM 表，插入操作和查询操作可以并行进行 </p>
<p>充分利用列有默认值</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/25/深入浅出mysql/" data-id="cjzqs9uw0000h5wpux0yekncp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-centos7安装mysql数据库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/13/centos7安装mysql数据库/" class="article-date">
  <time datetime="2019-08-13T11:49:42.000Z" itemprop="datePublished">2019-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/13/centos7安装mysql数据库/">centos7安装mysql数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>linux下通过rpm包安装mysql</strong>   (另外两种是 yum和源码包安装，源码包安装最优)</p>
<p>参考链接  <a href="https://blog.csdn.net/u012946310/article/details/81941571" target="_blank" rel="noopener">https://blog.csdn.net/u012946310/article/details/81941571</a>   </p>
<p>1.安装前，我们可以检测系统是否自带安装 MySQL:</p>
<blockquote>
<p>rpm -qa | grep mysql</p>
</blockquote>
<p>2.如果你系统有安装，那可以选择进行卸载:</p>
<blockquote>
<p>普通删除模式 rpm -e mysql  </p>
<p>强力删除模式，如果使用上面命令删除时，提示有依赖的其它文件，则用该命令可以对其进行强力删除</p>
<p>rpm -e –nodeps mysql</p>
</blockquote>
<p>3.下载地址：（x选择下载位置）</p>
<blockquote>
<p>wget  <a href="https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm" target="_blank" rel="noopener">https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</a></p>
</blockquote>
<p>（报错：wget command not found ，通过yum  -y install wget）</p>
<p>4.安装：</p>
<blockquote>
<p>rpm -ivh mysql57-community-release-el7-9.noarch.rpm yum install mysql-server</p>
</blockquote>
<p>   报错：Error: Package: akonadi-mysql-1.9.2-4.el7.x86_64 </p>
<p>​           Requires: mariadb-server</p>
<p>​           Removing: 1:mariadb-server-5.5.52-1.el7.x86_64 </p>
<p>​               mariadb-server = 1:5.5.52-1.el7</p>
<p>​           Obsoleted By: mysql-community-server-5.6.38-2.el7.x86_64 (mysql56-community)</p>
<p>​               Not found</p>
<p>​           Updated By: 1:mariadb-server-5.5.56-2.el7.x86_64 (base)</p>
<p>​               mariadb-server = 1:5.5.56-2.el7</p>
<p>You could try using –skip-broken to work around the problem</p>
<p>You could try running: rpm -Va –nofiles –nodigest</p>
<p>​    解决：rpm -qa | grep -i mysql</p>
<p>​    查看当前安装的mysql包</p>
<p>​    如果存在mariadb-server-5.5.60-1.el7_5.x86_64等包，需要先删除。</p>
<blockquote>
<p>​    yum -y remove mariadb-libs</p>
</blockquote>
<p>   然后再执行</p>
<blockquote>
<p>yum install mysql-server</p>
</blockquote>
<p>报错：[Errno 256] No more mirrors to try.</p>
<p>   解决：yum update 更新一遍安装库，然后继续执行安装，成功</p>
<p>5.安装成功后，初始化mysql</p>
<blockquote>
<p>​    mysqld –initialize</p>
</blockquote>
<p>（yum报错another app is currently holding the yum lock;waiting for it to exit：#rm -f /var/run/yum.pid强制关闭进程）</p>
<p>6.启动 MySQL：</p>
<p>​        service mysqld start</p>
<p>​        报错：[root@localhost local]# service mysqld start</p>
<p>​        Redirecting to /bin/systemctl start  mysqld.service</p>
<p>​        Job for mysqld.service failed because the control process exited with error   code. See “systemctl status mysqld.service” and “journalctl -xe” for details.</p>
<p>​        解决：查看报错日志，more  /var/log/mysqld.log</p>
<p>​        在mysql错误日志里出现：[ERROR] InnoDB: The innodb_system data file ‘ibdata1’ must be writable，及ibdata1必须可写那么解决方案自然是更改对应权限</p>
<p>​        mysql5.7版本以后是chmod -R 777 /var/lib/mysql</p>
<p>​        再次启动mysql成功，查看状态： service mysqld status</p>
<p>​    </p>
<p>7.验证 MySQL 安装：</p>
<blockquote>
<p>使用 mysqladmin 工具来获取服务器状态：</p>
</blockquote>
<blockquote>
<p>mysqladmin –version</p>
</blockquote>
<blockquote>
<p>如果以上命令执行后未输入任何信息，说明你的Mysql未安装成功。</p>
</blockquote>
<p>8.连接数据库，mysql -uroot -p</p>
<p>​    （1）报错（ERROR 1045 (28000): Access denied for user ‘root‘@’localhost’ (using password: YES)）</p>
<p>   修改密码：</p>
<p>​     步骤：</p>
<p>​           [1].停止mysql服务：service mysqld stop</p>
<p>​            [2].修改配置文件无密码登录：vi /etc/my.cnf</p>
<p>​            [3].在最尾部加上([mysqld]后面任意一行添加)：skip-grant-tables</p>
<p>​            [4].保存，启动mysql：service mysqld start</p>
<p>​            [5].登录mysql：mysql</p>
<p>​            [6].选中mysql数据库：mysql&gt; use mysql;</p>
<p>​            [7].首先更新root密码为空字符串：update user set authentication_string=’’ where user=’root’;</p>
<p>​            [8].退出，删除之前步骤加上的 “skip-grant-tables” 然后重启mysql：</p>
<p>// 1，退出:exit // 2，修改，删除最后的skip-grant-tablesvim /etc/my.cnf // 3，重启service mysqld restart</p>
<p>​            [9].然后在登陆Mysql：mysql -uroot</p>
<p>​            [10].使用ALTER修改root用户密码,方法：ALTER user ‘root‘@’localhost’ IDENTIFIED BY ‘你的密码’;</p>
<p>9.修改数据库字符集</p>
<p>​    （1）.登陆mysql查询当前字符集：</p>
<p>​        mysql&gt;  show variables like ‘char%’;</p>
<p>​    （2）.编辑my.con配置文件</p>
<p>​         vim /etc/my.cnf</p>
<p>​        添加： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[client] 		</span><br><span class="line">default-character-set=utf8mb4 		</span><br><span class="line">[mysql] 		</span><br><span class="line">default-character-set=utf8mb4 </span><br><span class="line">[mysqld] 	</span><br><span class="line">character-set-server=utf8mb4</span><br></pre></td></tr></table></figure>
<p>​       （3）保存退出，重新启动mysql：service mysqld restart</p>
<p>a.centos7 <strong>开启3306端口</strong></p>
<ol>
<li>systemctl start firewalld 开启防火墙</li>
<li>firewall-cmd –zone=public –add-port=3306/tcp –permanent</li>
<li>firewall-cmd –reload</li>
</ol>
<blockquote>
<p>–zone #作用域</p>
<p>–add-port=80/tcp #添加端口，格式为：端口/通讯协议</p>
<p>–permanent #永久生效，没有此参数重启后失效</p>
</blockquote>
<p>b. <strong>mysql授权</strong></p>
<p> 允许root用户从任何ip登录（参考链接 <a href="https://www.cnblogs.com/DaDaOnline/p/5535610.html" target="_blank" rel="noopener">https://www.cnblogs.com/DaDaOnline/p/5535610.html</a>）</p>
<ol>
<li>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root‘@’%’ IDENTIFIED BY ‘root’ WITH GRANT OPTION;  </li>
<li>FLUSH   PRIVILEGES; </li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/13/centos7安装mysql数据库/" data-id="cjzqs9uux00005wpueevx9ow2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-linux安装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/13/linux安装/" class="article-date">
  <time datetime="2019-08-13T11:48:47.000Z" itemprop="datePublished">2019-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/13/linux安装/">linux安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>linux安装遇到的问题（linux 历史版本下载 <a href="https://wiki.centos.org/Download" target="_blank" rel="noopener">https://wiki.centos.org/Download</a> ）</p>
<p>之后使用yum命令报错Could not retrieve mirrorlist</p>
<p>1.查看yum是否正常安装</p>
<p>2.验证配置 resolv.conf是否正确</p>
<blockquote>
<p>vi /etc/resolv.conf</p>
</blockquote>
<p>添加如下配置 （i修改）</p>
<blockquote>
<p>nameserver 8.8.8.8</p>
<p>search localdomain</p>
</blockquote>
<p>（:wq  保存并退出）</p>
<p>3.验证网卡配置</p>
<p>修改网卡配置，让网卡随操作系统自启，确保是root账号进行下面操作</p>
<blockquote>
<p>cd /etc/sysconfig/network-scripts </p>
</blockquote>
<p>修改网卡配置文件，把“ONBOOT”的值修改为”yes</p>
<blockquote>
<p>vi ifcfg-ens33 </p>
</blockquote>
<p>保存后重启操作系统，验证yum是否正常工作</p>
<blockquote>
<p>yum provides ifconfig</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/13/linux安装/" data-id="cjzqs9uvh00085wpuut7nh0za" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用WebSocket和STMOP实现消息功能" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/07/使用WebSocket和STMOP实现消息功能/" class="article-date">
  <time datetime="2019-08-07T11:05:39.000Z" itemprop="datePublished">2019-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/07/使用WebSocket和STMOP实现消息功能/">使用WebSocket和STMOP实现消息功能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>在浏览器和服务器之间发送消息</li>
<li>在SpringMVC控制器中处理消息</li>
<li>为目标用户发送消息</li>
</ul>
<p>Spring4.0为WebSocket通信提供了支持（包括发送和接收消息的低层级API ，高级API，发消息的模板，支持SockJS，用来解决浏览器端度无端以及代理不支持WebSocket的问题</p>
<p>使用低层级API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MacroHandler</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MacroHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">( WebSocketSession session , //处理文本消息</span></span></span><br><span class="line"><span class="function"><span class="params">         TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       logger.info(<span class="string">"Received message:"</span> + message.getPayload());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);<span class="comment">//模拟消息延时</span></span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> TextMessage(<span class="string">"Sail"</span>)); <span class="comment">//发送文本信息</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了处理文本等信息，还有链接的建立和关闭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span></span></span><br><span class="line"><span class="function">    throw Exception</span>&#123;</span><br><span class="line">    logger.info(<span class="string">"connection established"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span></span></span><br><span class="line"><span class="function">	theow Exception</span>&#123;</span><br><span class="line">    logger.info(<span class="string">"Connection closed . status: "</span> + status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已经有了消息处理器类，在配置类上使用@EnableWebSocket，并实现WebSocketConfigurer<br>接口 ， java方式配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandler</span><span class="params">(WebSocketHandlerRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.addHandler(macroHandler(), <span class="string">"//marco"</span>);<span class="comment">//将MacroHandr映射到“/macro"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">   	<span class="function"><span class="keyword">public</span> MarcoHandler <span class="title">marcoHandler</span><span class="params">()</span></span>&#123;<span class="comment">//声明MarcoHandler bean</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarcoHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>借助webSocket命名空间以XML方式配置WebSocket</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">websocket:handlers</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">websocket:mapping</span> <span class="attr">handler</span> =<span class="string">"marcoHandler"</span> <span class="attr">path</span>=<span class="string">"/marco"</span> /&gt;</span><span class="comment">&lt;!--将MarcoHandle 映射到/marco --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">websocket:handlers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"marcoHandler"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"marcopolo.MarcoHandler"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>应对不支持WebSocket的场景</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandler</span><span class="params">(WebSocketHandlerRegistry registry)</span></span>&#123;</span><br><span class="line">      registry.addHandler(macroHandler(), <span class="string">"//marco"</span>).withSockJS();<span class="comment">//将MacroHandr映射到“/macro" ,并启用SockJS</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>使用STOMP消息</p>
<p>Java配置启用基于代理的Web消息功能(@EnableWebSocketMessageBroker注解能够在<br>WebSocket之上启用STOMP )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketStompConfig</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketMessageBrokerConfigurer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndPointRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.addEndPoint(<span class="string">"/marcopolo"</span>).withSocketJS();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.enableSimpleBroker(<span class="string">"/queue"</span>,<span class="string">"/topic"</span>);</span><br><span class="line">        registry.setApplicationDestinationPrefixes(<span class="string">"/app"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理客户端的STOMP消息  <strong>@MessageMapping</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarcoController</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MarcoController.class);</span><br><span class="line">    <span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)  <span class="comment">//关键注解 </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;   <span class="comment">// 处理发往/app/marco目的地的消息</span></span><br><span class="line">        logger.info(<span class="string">"Received message: "</span> + incoming.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为不是HTTP，所以无法使用HttpMessageConverter实现将负载转为Shout对象</p>
<p>有如下几个消息转换器可以处理Message</p>
<table>
<thead>
<tr>
<th>消息转换器</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ByteArrayMessageConverter</td>
<td>实现MIME类型为“application/octetstream”的消息与byte[]之间的相互转换</td>
</tr>
<tr>
<td>MappingJackson2MessageConverter</td>
<td>实现MIME类型为“application/json”的消息与Java对象之间的相互转换</td>
</tr>
<tr>
<td>StringMessageConverter</td>
<td>实现MIME类型为“text/plain”的消息与String之间的相互转换</td>
</tr>
</tbody>
</table>
<p>处理订阅<strong>@SubscribeMapping</strong> </p>
<p>发送消息到客户端</p>
<ol>
<li>作为处理消息或定于的附带结果</li>
<li>使用消息模板</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Shout <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;</span><br><span class="line">    Shout outgoing = <span class="keyword">new</span> Shout();</span><br><span class="line">    outgoing.setMessage(<span class="string">"Polo"</span>);</span><br><span class="line">    <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认帧所发往的目的地会与触发处理器方法的目的地相同 ，可以添加<strong>@SendTo</strong>注解重载目的地</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageMapping</span>(<span class="string">"/marco"</span>)</span><br><span class="line"><span class="meta">@SendTo</span>(<span class="string">"/topic/shout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Shout <span class="title">handleShout</span><span class="params">(Shout incoming)</span></span>&#123;</span><br><span class="line">    Shout outgoing = <span class="keyword">new</span> Shout();</span><br><span class="line">    outgoing.setMessage(<span class="string">"polo"</span>);</span><br><span class="line">    <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@SendToUser</strong> 发送给订阅客户</p>
<p><strong>@MessageExceptionHandler</strong>能处理消息方法中的异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessageExceptionHandler</span>(SpittleException,<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span>  <span class="title">SpittleException</span> <span class="title">handleException</span>(<span class="title">SpittleException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">    logger.error(<span class="string">"Error handling message: "</span> + e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/07/使用WebSocket和STMOP实现消息功能/" data-id="cjzqs9uvu000e5wpuh5g4crbh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring消息" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/Spring消息/" class="article-date">
  <time datetime="2019-08-06T11:58:54.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/Spring消息/">Spring消息</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>异步消息简介</li>
<li>基于JMS的消息功能</li>
<li>使用Spring和AMQP发送消息</li>
<li>消息驱动的POJO</li>
</ul>
<p>1.发送消息</p>
<p>​    有两种通用的目的地：队列和主题，分别是点对点模型和发布/订阅模型</p>
<p>异步消息的优点</p>
<p>​    1.无需等待</p>
<p>​    2.面向消息和解耦</p>
<p>​    3.位置独立</p>
<p>​    4.确保投递</p>
<p>2.使用JMS发送消息</p>
<p>​    使用ActiveMQ</p>
<p>​    1.创建连接工厂</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.spring.ActiveMqConnectionFactory"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>ActiveMQConnectionFactory 会假设ActiveMQ代理监听localhost的61616端口，这样我们可以如下设置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.spring.ActiveMqConnectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:brokeURL</span>=<span class="string">"tcp://localhost:61616"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以通过如下方式声明</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:connectionFactory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">brokerURL</span>=<span class="string">"tcp：//localhost:61616"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>​        2.声明ActiveMQ消息目的地</p>
<p>​        如下定义了一个队列</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"queue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_</span>=<span class="string">"spitter.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>​        如下定义了一个ActiveMQ主题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"topic"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_</span>=<span class="string">"spitter.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>用amq方式声明
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:</span> <span class="attr">queue</span> <span class="attr">id</span>=<span class="string">"spittleQueue"</span> <span class="attr">physicalName</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amq:</span> <span class="attr">topic</span> <span class="attr">id</span>=<span class="string">"spottleTpoic"</span> <span class="attr">phtsicalName</span>=<span class="string">"spittle.alert.topic"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>不管是哪种类型，都是通过physicalName属性指定消息通道的名称</p>
<p>使用JMS模板</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlertServiceImpl</span> <span class="keyword">implements</span> <span class="title">AlertService</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> JmsOperations jmsIperations;</span><br><span class="line">    <span class="comment">//注入jms模板</span></span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlertServiceImpl</span><span class="params">(JmsOperations jmsOperations)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jmsOperations = jmsOperations;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSpittleAlert</span><span class="params">(<span class="keyword">final</span> Spittle spittle)</span></span>&#123;</span><br><span class="line">        jmsOperations.send(<span class="comment">//发送消息</span></span><br><span class="line">            <span class="string">"spittle.slert.queue"</span>,<span class="comment">//指定目的地</span></span><br><span class="line">            <span class="keyword">new</span> MessageCreator()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Meaasge <span class="title">createMessage</span><span class="params">(Session session)</span></span></span><br><span class="line"><span class="function">               	 throw JMSException</span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> session.createObjectMessage(spittle);<span class="comment">//创建消息</span></span><br><span class="line">            &#125;</span><br><span class="line">        	&#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置默认的目的地</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframeword.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestinationName</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面只是配了一个目的地名称，并没有说明你处理的目的地是什么类型，那么可以将之前的创建的队列或主题的目的地bean装配进来</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframeword.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestination-ref</span>=<span class="string">"spittleTopic"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认JMSTemplate在convertAndSend()方法中会使用 SImpleMessage  Converter。通过将消息转换器声明为bean，并注入到JMStemplate的messageConverter属性，可以重写，如果想用json，可以声名一个MappingJacksonMessageConverter bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageConverter"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframeword.jms.support.converter</span></span></span><br><span class="line"><span class="tag"><span class="string">             --&gt; MappingJacsonMessageConverter"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>注入到JmsTemplate中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:_-ref</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultDestinationName</span>=<span class="string">"spittle.alert.queue"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:messageConverter-ref</span>=<span class="string">"messageConverter"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">receiveSpittleAlert</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//接收消息</span></span><br><span class="line">        ObjectMessage receivedMessage = (ObjectMessage) jmsOperations.receive();</span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="keyword">return</span> (Spittle) receivedMessage.getObject();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(JMSException jmsException)&#123;</span><br><span class="line">        <span class="keyword">throw</span> JmsUtils.convertJmsAccessExceptiom(jmsException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MDP异步接收和处理消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleAlertHandler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleSpittleAlert</span><span class="params">(Spittle spittle)</span></span>&#123;<span class="comment">//处理方法</span></span><br><span class="line">        <span class="comment">//...implementation goes here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleSpittleAlert是个纯粹的POJO，可以在Spring中配置消息监听器使他获取消息接收能力，配置如下</p>
<p>1.将处理器声明为bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"spittleHandler"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.habuma.spittr.alerts.SpittleAlertHandler"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.把SpittleAlertHandler 声明为消息监听器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jms:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">jms:listener</span> <span class="attr">destination</span>=<span class="string">"spitter.alert.queue"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">ref</span>=<span class="string">"spittleHandler"</span> <span class="attr">method</span>=<span class="string">"handleSpittleAlert"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jms:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用基于消息的RPC 17.2</p>
<p>使用AMQP实现消息功能</p>
<p>AMQP在消息生产者和传递信息的队列之间引入了一种简介的机制Exchange。生产者和消息队列之间实现了解耦，Exchange这不仅仅是穿透，根据算法的不同，可能会使用消息的routing key 和/ 或者参数， 将Exchange 和队列的binding的routing key和参数进行对比</p>
<table>
<thead>
<tr>
<th>Exchange类型</th>
<th>条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Direct</td>
<td>消息的routing key与binding的routing key直接匹配的话，消息会路由到该队列上</td>
</tr>
<tr>
<td>Topic</td>
<td>消息的routing key与binding的routing key符合通配符匹配，消息会路由到该队列上</td>
</tr>
<tr>
<td>Headers</td>
<td>消息参数表中的头信息和值都与binding参数表中匹配，消息会路由到该队列上</td>
</tr>
<tr>
<td>Fanout</td>
<td>不管消息的routing key和参数表的头信息/值是什么， 消息将会路由到所有队列上</td>
</tr>
</tbody>
</table>
<p>配置RabbitMq</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改连接信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionfactory"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置RabbitTemplate </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"rabbitTemplate"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">connection-factory</span>=<span class="string">"connectinFactory"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用RabbitTemplate来发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlertServiceImpl</span> <span class="keyword">implements</span> <span class="title">AlertService</span></span>&#123;</span><br><span class="line">    priivate RabbitTemplate rabbit;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlertServiceImpl</span> <span class="params">(RabbitTemplate rabbit)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbit = rabbit;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSpittleAlert</span><span class="params">(Spittle spittle)</span></span>&#123;</span><br><span class="line">        rabbit.convertAndSend(<span class="string">"spittle.alert.exchange"</span>,</span><br><span class="line">                             <span class="string">"spittle.alerts"</span>,</span><br><span class="line">                             spittle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RabbitTemplate接收消息</p>
<p>借助receive()方法可以从队列中获取一个Message对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Message message = rabbit.receive(<span class="string">"spittle.alert.queue"</span>);</span><br></pre></td></tr></table></figure>
<p>还可以配置默认消息队列</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">id</span> = <span class="string">"rabbitTemplate"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">exchange</span>=<span class="string">"spittle.alert.exchange"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">routing-key</span>=<span class="string">"spittle.alerts"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">queue</span>=<span class="string">"spittle.alert.queue"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Spittle spittle = (Spittle) rabbit.receiveAndConvert(<span class="string">"spittle.alert.queue"</span>);</span><br></pre></td></tr></table></figure>
<p>receiveAndConvert()方法或使用和sendAndConvert() 相同的消息转换器，将Message转换成原始的类型</p>
<p>调用这两个方法都会立即返回结果，如果队列中没等待的消息，那结果就是null,这时候需要我们来管理轮询（polling）以及必要的线程，实现队列的监控</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/Spring消息/" data-id="cjzqs9uv700025wpubwvf3506" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用SpringMVC创建REST" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/使用SpringMVC创建REST/" class="article-date">
  <time datetime="2019-08-06T11:58:14.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/使用SpringMVC创建REST/">使用SpringMVC创建REST</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>编写处理REST资源的控制器（替换 soap web 服务，更方便）</li>
<li>以XML、JSON以及其他格式表示资源</li>
<li><p>使用REST资源</p>
<p>1.REST与RPC不同，RPC是面向服务的，并且关注行为和动作，而REST则是面向资源，强调描述应用程序的事务和名词</p>
</li>
</ul>
<p>rest<strong>资源</strong>可以使用各种形式进行<strong>表述</strong>（representional），包括xml，json甚至html；使用rest的时候，我们更应该关注资源的<strong>状态</strong>（State而不是对资源采取的行为;rest资源数据<strong>转移</strong>，以某种形式转移到另一种应用。（其实REST就是将资源的状态以最合适客户端或者服务端的形式从服务端转移到客户端或者相反）注重<strong>事物</strong>不是行为。</p>
<p>2.Spring支持Rest的方式</p>
<p>​    1.控制器可以处理所有HTTP方法（主要get,put,post,delete）</p>
<p>​    2.借助<strong>@PathVariable</strong>注解，控制器能处理参数化的URL（将变量输入当成URL的一部分）</p>
<p>​    3.借助Spring视图和视图解析器，资源能够以多种方式进行描述，包括将数据模型渲染成XML，JSON，Atom以及RSS的view</p>
<p>​    4.可以使用ContentNegotiatingViewResolver来选择客户端表述</p>
<p>​    5.借助<strong>@ResponseBody</strong>注解和各种<strong>HttpMethodConverter</strong>实现，能替换基于视图的渲染方式也可以将传入的HTTP数据转化为传入控制器处理方法的Java对象。</p>
<p>​    6.借助RestTemplate，Spring应用能更方便地使用Rest资源</p>
<p>Spring的ContentNegotiatingViewResolver是一个特殊的视图解析器，配置方式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内容协商的两个步骤</p>
<p>1.确定请求的媒体类型</p>
<p>2.找到适合请求媒体的最佳视图</p>
<p>即使确定所请求媒体类型默认的策略，我们也可以通过设置ContentNegotiationManager去改变他的行为</p>
<p>有三种方式可以配置ContentNegotiationManager ，推荐后两种</p>
<ul>
<li>声明ContentNegotiationManager的bean</li>
<li>通过ContentNegotiationManagerFactoryBean间接创建bean</li>
<li>重载WebMvcConfigurerAdapter的configureContentNegotiation()方法</li>
</ul>
<p>xml配置最简方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"contentNegotiationManager"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.http.ContentNegotiationManagerFactoryBean"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultContentType</span>=<span class="string">"application/json"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>java配置最简方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span></span>&#123;</span><br><span class="line">    configurer.defaultContentType(MediaType.APPLICATION_JSON)；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面已经有了ContentNegotiationManagerbean,那么现在要将它注入到ContentNegotiatingViewResolver的</p>
<p>contentNegotiationManager属性中，修改ContentNegotiatingViewResolver的@Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">(ContentNegotiationManager cnm)</span></span>&#123;</span><br><span class="line">    ContentNegotiatingViewResolver cnvr = <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">    cnvr.setContentNegotiationManager(cnm);</span><br><span class="line">    <span class="keyword">return</span> cnvr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Http信息转换器</p>
<p>使用@ResponseBody注解，这样Spring会知道将返回的对象作为资源发送给客户端（以客户端想要的形式） ，而且DispatcherServlet会考虑到请求中Accept头部信息，并寻找合适的消息转换器</p>
<p>Jackson默认使用反射</p>
<p>使用@RequestBody，Spring会查看请求中的Content-Type头部信息，并寻找合适的消息转换器</p>
<p>Spring4.0之后使用<strong>@RestController</strong>注解，替换@Controller，就不需要每个方法添加@ResponseBody了，使用@RestController注解之后控制器，该方法返回的对象将会通过消息转换机制，产生客户端所需的资源表述</p>
<p>提供资源之外的其他内容</p>
<p>@ResponseBody提供了一种很有用的方式，能够将控制器返回的Java对象转换为客户端的资源表述，但是这个只是REST API一部分,还能提供额外的元数据。</p>
<p>Spring提供了多种方式处理</p>
<ul>
<li>@ResponseStatus可以指定状态码</li>
<li>控制器方法可以返回@ResponseEntity对象，该对象可以包含更多响应相关的元数据</li>
<li>异常处理器能够应对错误场景，这样处理器方法就能关注正常状况（@ExceptionHandler）</li>
</ul>
<p>编写REST客户端</p>
<p>举个栗子，我们借助FaceBook的Graph API来获取某人的FaceBook基本信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Profile <span class="title">fetchFaceBookProfile</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      	<span class="comment">//创建客户端</span></span><br><span class="line">        HttpClient client = HttpClient.createDefault();</span><br><span class="line">        <span class="comment">//创建请求</span></span><br><span class="line">        HttpGet request = <span class="keyword">new</span> HttpGet(<span class="string">"http://graph.facebook.com/"</span>+id);</span><br><span class="line">        request.setHeader(<span class="string">"Accept"</span>,<span class="string">"application/json"</span>);</span><br><span class="line">        <span class="comment">//执行请求</span></span><br><span class="line">        HttpResponse response = client.execute(request);</span><br><span class="line">        HttpEntity entity = response.getEntity();</span><br><span class="line">        <span class="comment">//将响应映射为对象</span></span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMappe();</span><br><span class="line">        <span class="keyword">return</span> mapper.readValue(entity.getContent(),Profile.class);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>了解RestTemplate//待续</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/使用SpringMVC创建REST/" data-id="cjzqs9uvr000d5wpucrozgeot" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用远程服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/06/使用远程服务/" class="article-date">
  <time datetime="2019-08-06T11:54:46.000Z" itemprop="datePublished">2019-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/06/使用远程服务/">使用远程服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>访问和发布RMI服务</li>
<li>使用Hessian和Burlap服务</li>
<li>使用Spring的Hppt invoker</li>
<li>使用Spring开发Web服务</li>
</ul>
<p>spitter应用的服务层并使用RmiServiceExporter将服务发布为RMI服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterService</span></span>&#123;</span><br><span class="line">    <span class="function">Spitter get <span class="title">Spitter</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RmiServiceExporter <span class="title">rmiExporter</span><span class="params">(SpitterService spitterService)</span></span>&#123;</span><br><span class="line">   RmiServiceExporter rmiExporter = <span class="keyword">new</span> RmiServiceExporter();</span><br><span class="line">    <span class="comment">//RmiServiceExporter将POJO包装到服务适配器中，并将服务适配器绑定到RMI注册表中，从而将POJO转换为RMI服务</span></span><br><span class="line">    rmiExporter.setService(spitterService);</span><br><span class="line">    rmiExporter.setServiceName(<span class="string">"SpitterService"</span>);</span><br><span class="line">    rmiExporter.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="comment">//默认情况下，RmiServiceExporter会尝试绑定到本地机器1099端口上的RMI注册表，可以通过RegistryHost和ResitryPort来指定别的注册表</span></span><br><span class="line">    rmiExporter.setRegistryHost(<span class="string">"rmi.spitter.com"</span>);</span><br><span class="line">    rmiExporter.setRegistryPort(<span class="number">1199</span>);</span><br><span class="line">    <span class="keyword">return</span> rmiExporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Spring的RMiProxyFactoryBean是一个工厂bean，可以为RMI服务创建代理，只需配置Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RmiProxyFactoryBean <span class="title">spitterService</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RmiProxyFactoryBean rmiProxy = <span class="keyword">new</span> RmiProxyFactoryBean();</span><br><span class="line">    rmiProxy.setServiceUrl(<span class="string">"rmi://localhost/SpitterService"</span>);</span><br><span class="line">    rmiProxy.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="keyword">return</span> rmiProxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Spring的HttpInvoker,能执行基于Http的远程调用，并使用java的序列化机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpInvokerServiceExporter <span class="title">httpExportSpitterService</span><span class="params">(SpitterService service)</span></span>&#123;</span><br><span class="line">    HttpInvokerServiceExporter exporter= <span class="keyword">new</span> HttpInvokerServiceExporter();</span><br><span class="line">    expoerter.setService();</span><br><span class="line">    expoerter.setServiceInterface(SpitterService.class);</span><br><span class="line">    <span class="keyword">return</span> exporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为HttpInvokerServiceExporter是个SpringMvc控制器，我们需要建立一个URL处理器，映射Http url到对应的服务上，就像Hession和Burlap导出器所做的一样。</p>
<p>HttpInvokerServiceExporter的工作方式是（请求进入之后，有DispatcherServlet分发到HttpInvokerServiceExporter，再调用serviceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HandlerMapping <span class="title">httpInvokerMapping</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SimpleUrlHandlerMapping mapping = <span class="keyword">new</span> SimpleUrlHandlerMapping();</span><br><span class="line">    Properties mappings = <span class="keyword">new</span> Properties();</span><br><span class="line">    mapping.setProperty(<span class="string">"/spitter.service"</span>,<span class="string">"httpExportedSpitterService"</span>);</span><br><span class="line">    mapping.setMapping(mappings);</span><br><span class="line">    <span class="keyword">return</span> mapping;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>映射设置xml</p>
<p>发布和使用web服务（使用jaxWsPortProxyFactory）</p>
<p>客户端调用service方法，JaxWsPortProxyFactoryBean 生成代理，代理传递soap消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JaxWsPorrtProxyFactoryBean spitterService&#123;</span><br><span class="line">	JaxWsPorrtProxyFactoryBean proxy = <span class="keyword">new</span> JaxWsPorrtProxyFactoryBean();</span><br><span class="line">    proxy.setWsdlDocument(<span class="string">"http://8080/services/Spitter?wsdl"</span>);</span><br><span class="line">    proxy.setServiceName(<span class="string">"spitterService"</span>);</span><br><span class="line">    proxy.setPortName(<span class="string">"spitterServiceHttpPort"</span>);</span><br><span class="line">    proxy.setInterface(<span class="string">"SpitterService.class"</span>);</span><br><span class="line">    proxy.setNamespaceUri(<span class="string">"http://spitter.com"</span>);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>减少使用远程服务。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/06/使用远程服务/" data-id="cjzqs9uvp000c5wpuvbjz0xci" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-保护方法应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/保护方法应用/" class="article-date">
  <time datetime="2019-07-24T11:03:55.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/保护方法应用/">保护方法应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>保护方法调用</li>
<li>使用表达式定义安全规则</li>
<li>创建安全表达式计算器</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">注解</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">@preAuthorize</td>
<td style="text-align:left">在方法调动之前，基于表达式的计算结果来限制对方法的访问</td>
</tr>
<tr>
<td style="text-align:left">@PostAuthorize</td>
<td style="text-align:left">允许方法调用，如果表达式计算结果为false，则抛出一个安全性异常</td>
</tr>
<tr>
<td style="text-align:left">@PostFilter</td>
<td style="text-align:left">允许方法调用，但是必须按照表达式来过滤方法的结果</td>
</tr>
<tr>
<td style="text-align:left">@PreFilter</td>
<td style="text-align:left">允许方法调用，但是必须在进入方法前过滤输入值</td>
</tr>
</tbody>
</table>
<p>未完待续…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/保护方法应用/" data-id="cjzqs9uw1000i5wpuvzoo1vjq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-数据缓存" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/数据缓存/" class="article-date">
  <time datetime="2019-07-24T11:03:29.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/数据缓存/">数据缓存</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>启用声明式缓存</li>
<li>使用Ehance、Redis和gemFire实现缓存</li>
<li>注解驱动的缓存</li>
</ul>
<ol>
<li><p>启用对缓存的支持</p>
<p>Spring 对缓存的支持有两种方式</p>
<ol>
<li>注解驱动的缓存</li>
<li>XML声明的缓存</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>		<span class="comment">//启用缓存 （1，注解方式）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span></span>&#123;   <span class="comment">//声明缓存管理器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcurrentMapCacheManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache:annotation-driven</span>&gt;</span><span class="tag">&lt;/<span class="name">cache:annotation-driven</span>&gt;</span>  <span class="comment">&lt;!-- 启用缓存--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"cacheManager"</span> <span class="attr">class</span> = <span class="string">"org.springframeword.cache.concurrent.ConcurrentMapCacheManager"</span>  /&gt;</span>  <span class="comment">&lt;!--声明缓存管理器--&gt;</span></span><br></pre></td></tr></table></figure>
<p>@EnableCaching 和&lt;cache:annotation-driven /&gt; 工作方式相同，都是创建一个切面aspect去出发Spring缓存注解的切点pointcut,这个切面会从缓存中获取数据或者剔除数据 </p>
<p>配置<strong>EhCacheCacheManager</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>		<span class="comment">//启用缓存 （1，注解方式）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheCacheManager <span class="title">cacheManager</span><span class="params">(CacheManager cm)</span></span>&#123;   <span class="comment">//配置EhCacheCacheManager</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EhCacheCacheManager(cm);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheManagerFactoryBean <span class="title">ehcache</span><span class="params">()</span></span>&#123;  <span class="comment">//EhCacheManagerFactoryBean</span></span><br><span class="line">        EhCacheManagerFactoryBean ehCacheFactoryBean = </span><br><span class="line">            <span class="keyword">new</span> EhCacheManagerFactoryBean();</span><br><span class="line">        ehCacheFactoryBean.setConfigLaication(</span><br><span class="line">        	<span class="keyword">new</span> ClassPathResource(<span class="string">"com/sail/cache/ehcache.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> ehCacheFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span> <span class="comment">&lt;!--基础配置ehcache.xml--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span> = <span class="string">"spittleCache"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">maxBytesLocalHeap</span> = <span class="string">"50m"</span> </span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span> = <span class="string">"100"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>cacheManager()方法创建了一个EhCacheCacheManager的实例,这里其实要把CacheManager 给注入到EhCacheCacheManager中</p>
<p>使用<strong>Redis</strong>缓存（Spring Data Redis 提供了RedisCacheManager  ）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisTemplate redisTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisTemplate); <span class="comment">//Redis缓存管理器bean</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span></span>&#123;  <span class="comment">//Redis链接工厂bean</span></span><br><span class="line">        JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">        jedisConnectionFactory.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> jedisConnectionFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,String&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redidCF)</span>	</span>&#123; <span class="comment">//RedisTemplate bean</span></span><br><span class="line">        RedisTemplate&lt;String ,String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;String,String&gt;;</span><br><span class="line">        redisTemplate.setConnectionFactory(residCf);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为方法添加注解以支持缓存 ,,,也可以放到类上</p>
<p>@Cacheable和@Cacheput </p>
<p>这两者的区别是@Cacheable是会条件性触发 而带有@CachePut的注解方法始终都会被调用，方法返回值也会存在缓存中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(<span class="string">"spittleCache"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(</span><br><span class="line">        SELECT_SPITTLE_BY_ID, <span class="keyword">new</span> SpittleRowMapper(), id);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(EmptyResultDataAccessException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当findOne()被调用时，缓存切面会拦截调用并在缓存中查找以名为spittleCache存储的返回值，key是传递到findone中的id，如果没找到，就会调用这个方法并将返回值放到缓存之中。</p>
<p>使用<strong>XML</strong>声明缓存</p>
<p>要配置xml声明的环迅，需要创建Spring配置文件，这个文件中药包含cache和aop命名空间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span> <span class="comment">&lt;!--将缓存通知绑定到一个切点上--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span> = <span class="string">"cacheAdvice"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">pointcut</span> = <span class="string">"execution((* com.sail.spittr.db.SpittleRepository.*(..)))"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cache:advice</span> <span class="attr">id</span> = <span class="string">"cacheAdvice"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">cache:caching</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">cache:cacheable</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">method</span> = <span class="string">"findRecent"</span> /&gt;</span> <span class="comment">&lt;!--配置为支持缓存--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cache:cache-put</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span> </span></span><br><span class="line"><span class="tag">                         <span class="attr">method</span> = <span class="string">"save"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">key</span> = <span class="string">"#result.id"</span>/&gt;</span> <span class="comment">&lt;!--save是填充缓存--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cache:cache-evict</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span> </span></span><br><span class="line"><span class="tag">                           <span class="attr">method</span> = <span class="string">"remove"</span> /&gt;</span> <span class="comment">&lt;!--从缓存中移除--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache:caching</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache:advice</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"cacheManager"</span> <span class="attr">class</span> = <span class="string">"org.springframeword.cache.concurrent.ConcurrentMapCacheManager"</span>  /&gt;</span>  <span class="comment">&lt;!--声明缓存管理器，cache-advide中默认的是使用名为cacheManager--&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/数据缓存/" data-id="cjzqs9uwz000j5wpu6zpgcq42" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用NoSql数据库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/24/使用NoSql数据库/" class="article-date">
  <time datetime="2019-07-24T11:02:46.000Z" itemprop="datePublished">2019-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/24/使用NoSql数据库/">使用NoSql数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用<strong>Spring Data MongoDB</strong>（1.通过注解实现对象-文档映射 2.使用MongoTemplate 实现基于模板的数据库访问 3.自动化运行时Repository生成）</p>
<p>1.借助@EnableMongoRepositories启用Spring Data MongoDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(<span class="string">"order.db"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMongoConfiguration</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDatabaseName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OrderDB"</span>; <span class="comment">//指定数据库名称</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MongoClient();  <span class="comment">//创建Mongo客户端</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.创建MongoClient来访问需要认证的MongoDB服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Enviroment env;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	MongoCredential credential = MongoCredential.createMongoCRCredential(</span><br><span class="line">    env.getProperty(<span class="string">"mongo.username"</span>),</span><br><span class="line">    <span class="string">"OrderDB"</span>,</span><br><span class="line">    env.getProperty(<span class="string">"mongo.password"</span>).toCharArray())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlns:mongo="http:www.springftameword.org/schema/data/mongo" <span class="comment">&lt;!-- 声明mongo命名空间--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mongo:repositories</span> <span class="attr">base-package</span>=<span class="string">"orders.db"</span>/&gt;</span>  <span class="comment">&lt;!-- 启用Repository 生成功能--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mongo:mongo</span> /&gt;</span> <span class="comment">&lt;!-- 声明 Mongo Client --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--创建MongoTemplate bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"mongoTemplate"</span>  </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span> = <span class="string">"org.springframework.data.mongodb.core.MongoTemplate"</span></span></span><br><span class="line">      &lt;constructor-arg ref="mongo"/&gt;</span><br><span class="line">	  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"OrdersDB"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>MongoDB Repository </p>
<p>完全自定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderRepository extends MongoRepository&lt;Order ,String&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>OrderRepository扩展了MongoRepository因为Spring Data MongoDB 会自动实现Repository接口，所以会传递性地扩展Repository标记接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>（<span class="string">"&#123;'customer':'sailzjw' ,'type': ?0 &#125;"</span>）</span><br><span class="line"><span class="function">List&lt;Order&gt; <span class="title">findsailOrders</span><span class="params">(String s)</span></span>;</span><br></pre></td></tr></table></figure>
<p>@Query中给定的Json会与所有的Order文档进行匹配，并返回匹配的文档，这里type 属性映射成”?0” 表示type属性应该与查询方法的第0个参数相等，如果有多个参数的话，可以通过 ?1 ?2 方式引用</p>
<p>混合自定义</p>
<p>1定义中间接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">orderOperations</span></span>&#123;</span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">findOrderByType</span><span class="params">(String t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 将自定义Repository功能注入到自动生成的Repository中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">OrderPoerations</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoOperations mongo; <span class="comment">// 注入MongoOperations </span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findOrdersByType</span><span class="params">(String t)</span></span>&#123;</span><br><span class="line">        String type = t.equals(<span class="string">"NET"</span>) ? <span class="string">"WEB"</span> : t;</span><br><span class="line">        Criteria where = Criteria.where(<span class="string">"type"</span>).is(t);<span class="comment">//创建查询</span></span><br><span class="line">        Query query = Query.query(where);</span><br><span class="line">        <span class="keyword">return</span> mongo.find(query ,Order.class); <span class="comment">//执行查询</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>混合实现中注入了MongoOperations (也就是MongoTemplate所实现的接口)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderRepository extends MongoRepository&lt;Order ，String&gt;， orderOperations&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 修改OrderRepository 让其实现OrderOperations</p>
<p>使用<strong>Redis操作key-value</strong>数据 （HashMap）</p>
<p> <strong>RedisTemplate</strong> 和 <strong>StringRedisTemplate</strong></p>
<p>假设已经有RedisConnectionFactory 那么用如下方式构建RedisTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">RedisTemplate&lt;String ,Product&gt; redis = <span class="keyword">new</span> RedisTemplate&lt;String ,Product&gt;;</span><br><span class="line">redis.setConnectionFactory(cf);</span><br></pre></td></tr></table></figure>
<p>如果key-value都是String类型，那么就可以使用StringRedisTemplate来代替RedisTemplate</p>
<p>StringRedisTemplate有一个接受RedisConnectionFactory的构造器，因此没必要在构建后在调用setConnectionFactory()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">StringRedisTemplate redis = <span class="keyword">new</span> StringRedisTemlate(cf)</span><br></pre></td></tr></table></figure>
<p> 序列化</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/24/使用NoSql数据库/" data-id="cjzqs9uvy000g5wpux5845yay" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/25/深入浅出mysql/">深入浅出mysql</a>
          </li>
        
          <li>
            <a href="/2019/08/13/centos7安装mysql数据库/">centos7安装mysql数据库</a>
          </li>
        
          <li>
            <a href="/2019/08/13/linux安装/">linux安装</a>
          </li>
        
          <li>
            <a href="/2019/08/07/使用WebSocket和STMOP实现消息功能/">使用WebSocket和STMOP实现消息功能</a>
          </li>
        
          <li>
            <a href="/2019/08/06/Spring消息/">Spring消息</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 启航<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>